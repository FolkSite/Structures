function tinyBlocksSave(e,t){if("undefined"==typeof tinyBlocksCustomSave){if(!$("#tinyBlocksThrobber").length){tinyBlocksThrobber(1),tinymce.get(tinyBlocksOriginalSourceId)&&tinymce.get(tinyBlocksOriginalSourceId).remove(),$("#ace_wrapper_ta").length&&(ace.edit("ace_id_ta").destroy(),$("#ace_wrapper_ta").remove()),tinyBlocksResult=$(".tinyBlocksRowsWrapperClass").clone(!0,!0);var i=$(".tinyBlocksRowsWrapperClass").clone(!0,!0),n=tinyBlocksHiddenBlockClass+" "+tinyBlocksRowClass+" "+tinyBlocksNewBlockClass+" "+tinyBlocksShrinkBlockClass+" mceEditable";i.find("textarea.tb-tiny-rc-sub").each(function(){var e,t=$(this).parents(".tb-wrapper-tlb"),i=$(this).parents(".tb-tiny-rc");"PRE"==i[0].nodeName||"CODE"==i[0].nodeName?e=tinymce.html.Entities.encodeAllRaw($(this).val()):(t.attr("markdown",1),e=$(this).val()),$(this).parent().html(e)}),i.find(".tb-unwrap").each(function(){var e=$(this).attr("class"),t=$(this).attr("data-tb-title");$(this).children(":first").addClass(e).attr("data-tb-title",t).unwrap()}),i.find(".tinyBlocksRowTempHolderClass").find(".tinyBlocksRowTempHolderClass").children().not("[class*=tb-tiny-]").remove(),i.find(".tinyBlocksRowTempHolderClass .tinyBlocksRowTempHolderClass").contents().unwrap(),i.find("iframe, .tb-wrapper-tlb").unwrap(),i.html(i.children(".tb-wrapper-tlb")),i.find(".tb-wrapper-tlb:not(:last)").after("\n"),i.find(".tb-tiny-md").each(function(){var e=$(this).html();$(this).html(saveMyFootMarks(e)),$(this).attr("markdown",1)}),i.find("[id^=mce_]").removeAttr("id"),i.find(".tinyBlocksCE, [data-mce-bogus], .mce-shim, .coder").remove(),i.find("*").removeAttr("data-tb-rapid twprecodemanagerprecss contenteditable data-mce-href data-mce-selected data-mce-src data-mce-style").removeClass(n).alterClass("tinyBlocks* mce-* tb-custom-*",""),i.find('[class*="tb-tiny-"]').removeAttr("spellcheck style width height contenteditable"),i.find('[class=""]').removeAttr("class");var l=i.find(".tb-tiny-pure");l.length>1&&l.not(":first").prepend("[[-"+tinyBlocksProjectNameUC+"]]"),l.length&&l.contents().unwrap();var a=i.html().replace(/(?:&amp;gt;|&gt;)/g,">");t?(document.getElementById(tinyBlocksMainWrapperId+"_HTML").value=a,tinyBlocksThrobber(0)):(document.getElementById(tinyBlocksOriginalSourceId).value=a,setTimeout(function(){tinyBlocksThrobber(0),$("#modx-abtn-save").trigger("click")},500))}}else tinyBlocksCustomSave()}function tinyBlocksGallery(e){return"undefined"==typeof TinyJSONGallery?!1:void("begin"==e?(exitedGalleryToUseElementTree=0,tinyJSONGalleryTABtitle=tinyBlocksProjectName+" Gallery",$(document).on("mouseenter",".modx-window, .tvJSONGalleries",function(){var e,t;$(this).hasClass("tvJSONGalleries")?(1==exitedGalleryToUseElementTree&&$(".tvJSONGalleries").parent().addClass("tvChunkGalleries-parent"),e=" TV: "+$(this).parents(".modx-tv").find(".modx-tv-caption").text(),t=$(this).attr("id"),$(this).on("dblclick",function(){t&&1==exitedGalleryToUseElementTree&&!$("#tinyJSONGalleryWrapper").length&&popGal(t,tinyJSONGalleryTABtitle+e)})):(1==exitedGalleryToUseElementTree&&$(this).find("textarea[name=snippet]").parents(".modx-window").addClass("tvChunkGalleries-parent"),$(this).find("textarea[name=snippet]:visible").addClass("chunkJSONGalleries"),t=$(this).find("textarea[name=snippet]").attr("id"),e=" Chunk: "+$(this).find(".x-window-header-text > span").text(),$(this).find(".chunkJSONGalleries").on("dblclick",function(){t&&1==exitedGalleryToUseElementTree&&!$("#tinyJSONGalleryWrapper").length&&popGal(t,tinyJSONGalleryTABtitle+e)}))})):"on"==e||0===exitedGalleryToUseElementTree?(exitedGalleryToUseElementTree=1,$("#modx-tv-tabs textarea:not(.modx-richtext, .tb-gallery-tv)").addClass("tvJSONGalleries").parent().addClass("tvChunkGalleries-parent"),"on"==e&&"undefined"==typeof globalSONGalleries?(tinymce.get("tmpTempEditor").windowManager.alert("Global Gallery ON: just dblclick chunks textarea"),globalSONGalleries=1):"on"!==e&&(tinymce.get("tmpTempEditor").windowManager.alert("Global TV/Chunk Gallery ON"),globalSONGalleries=1)):(exitedGalleryToUseElementTree=0,$(".tvJSONGalleries").removeClass("tvJSONGalleries"),$(".tvChunkGalleries-parent").removeClass("tvChunkGalleries-parent"),tinymce.get("tmpTempEditor").windowManager.alert("Global Gallery is now OFF")))}function tinyBlocksGalleryGetChunk(e){tinyBlocksThrobber(1),MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"element/chunk/get",id:e},listeners:{success:{fn:function(e){var t=MODx.load({xtype:"modx-window-quick-update-chunk",record:e.object,listeners:{success:{fn:function(){},scope:this},hide:{fn:function(){this.destroy()}}}});t.title+=': <span id="tjg-'+t.record.id+'" dir="ltr">'+t.record.name+" ("+t.record.id+")</span>",t.setValues(e.object),t.show();var i=" Chunk: "+t.record.name+" ("+t.record.id+")",n=$("#tjg-"+t.record.id).parents(".modx-window").find("textarea[name=snippet]").attr("id");tinyBlocksThrobber(0),popGal(n,tinyJSONGalleryTABtitle+i)}},failure:{fn:function(){tinyBlocksThrobber(0)}}}})}function tinyBlocksDefaultGalleryInit(){$("#tv"+tinyBlocksDefaultGallery).length?popGal("tv"+tinyBlocksDefaultGallery,tinyBlocksProjectName+" Gallery TV"):tinymce.get("tmpTempEditor").windowManager.alert("Gallery TV "+tinyBlocksDefaultGallery+" is not currently visibly attached to this Resource")}function tinyBlocksGalleryTinyJSON(){function e(e){tinymce.get("tmpTempEditor").windowManager.alert("Error! "+e,tinyBlocksTitle)}if($(".tinyBlocksActive").length){var t=$(".tinyBlocksActive").find(".tb-title").text(),i=t.replace(/[^a-zA-Z0-9\- ]/g,"").replace(/\s/g,"");if("undefined"!=typeof TinyJSONGallery)if(i)if(i=i.toLowerCase().substr(i.lastIndexOf("-")+1),i.indexOf("tv")>=0)if(isNaN(i)&&!isNaN(i.substr(i.lastIndexOf("tv")+2))){var n=" TV: "+$("#"+i).parents(".modx-tv").find(".modx-tv-caption").text();$("#"+i).length?popGal(i,tinyJSONGalleryTABtitle+n):e("'"+i+"' is not currently visibly attached to this Resource")}else e("Valid title: etc-TV34");else i.indexOf("ch")>=0?(i=i.substr(i.lastIndexOf("ch")+2),isNaN(i)?e("Valid title: etc-CH34"):tinyBlocksGalleryGetChunk(i)):e("Valid title: CH23 or TV34 or 'Title-CH23' or 'Another Title-TV34'");else e("Valid title: CH23 or TV34 or 'Title-CH23' or 'Another Title-TV34'");else tinymce.get("tmpTempEditor").windowManager.alert("Error! TinyJSONGallery is not loaded")}else tinymce.get("tmpTempEditor").windowManager.alert("Needs an active block: hovered")}function tinyBlocksRapidImage(e,t,i){if("undefined"==typeof tinyBlocksCustomRapidImage){$("#tb-alert-input").show();var n,l,a=tinymce.activeEditor.getParam("tbRapidImageSettings",{}).uploadScriptUrl,o=tinymce.activeEditor.getParam("tbRapidImageSettings",{}).uploadPath||"",r=tinymce.activeEditor.getParam("tbRapidImageSettings",{}).uploadUrl||"";n=new XMLHttpRequest,n.withCredentials=!0,n.open("POST",a+"?path="+o+"&url="+r),n.onload=function(){var e;return 200!=n.status?void i("HTTP Error: "+n.status):(e=JSON.parse(n.responseText),e&&"string"==typeof e.location?void t(e.location):void i("Invalid JSON: "+n.responseText))},l=new FormData;var s=function(t,i){var a,o;"ok"==t?i?(a=i,l.append("file",e.blob(),a),n.send(l),tinymce.activeEditor.getParam("tbRapidImageSettings",{}).tempFilename=a,o=$(tinymce.activeEditor.getBody()).find("img").each(function(){$(this).attr("src").indexOf("blob:")>=0&&$(this).attr("data-tb-rapid",a)})):$(tinymce.activeEditor.getBody()).find("img[src*='blob:'][data-tb-rapid]").length?(a=$(tinymce.activeEditor.getBody()).find("img[src*='blob:'][data-tb-rapid]").data("tb-rapid"),l.append("file",e.blob(),a),n.send(l),tinymce.activeEditor.getParam("tbRapidImageSettings",{}).tempFilename=a):$(tinymce.activeEditor.getBody()).find("img[src*='blob:']").length&&(a=e.filename(),l.append("file",e.blob(),a),n.send(l),tinymce.activeEditor.getParam("tbRapidImageSettings",{}).tempFilename=a,o=$(tinymce.activeEditor.getBody()).find("img").each(function(){$(this).attr("src").indexOf("blob:")>=0&&$(this).attr("data-tb-rapid",a)})):$(tinymce.activeEditor.getBody()).find("img[src*='blob:']").remove()},c="Valid <b>image.ext</b> names only",d='<span id="tb-alert-input"><i>Identical</i> name will overwrite duplicate server image<br><i>Cancel</i> will remove present data image from editor<br></span>',y=new Date,u=y.getFullYear()+"_"+(y.getMonth()+1)+"_"+y.getDate()+"__"+y.getHours()+"_"+y.getMinutes()+"_"+y.getSeconds(),m=e.filename().substr(e.filename().lastIndexOf(".")+1),p="temp_"+u+"."+m;Ext.MessageBox.prompt(c,d,s);var g=$(tinymce.activeEditor.getBody()).find("img[src*='blob:']").data("tb-rapid")||$(tinymce.activeEditor.getBody()).find("img[data-mce-selected]").data("tb-rapid")||p,h=$("#tb-alert-input").parent().parent();h.find("input").val(g)}}function tinyBlocksToolsMenu(){$(".mce-tinyBlocksTools").prependTo("#tinyBlocksControlButtonsWrapper").hide(),tinyBlocksMouseHoverTraffic=0}function tinyBlocksClearAll(e){var t=document.getElementById(tinyBlocksMainWrapperId),i=$(t).find(".tinyBlocksRowTempHolderClass"),n=$(t).find(".tinyBlocksRowTempHolderClass.ui-selected");if(i.length){var l="<b>Every</b> Block will be removed";n.length&&(l="<b>"+n.length+"</b> Selected Block(s) will be removed");var a=function(e){"ok"==e&&(tinyBlocksThrobber(1),setTimeout(function(){tinyBlocksToolsMenu(),n.length?(n.find(".mce-content-body").each(function(){$(this).tinymce().remove()}),n.remove(),tinyBlocksLoneOrNoBlock(),tinyBlocksThrobber(0)):(i.find(".mce-content-body").each(function(){$(this).tinymce().remove()}),i.parent().empty(),tinyBlocksLoneOrNoBlock(),tinyBlocksThrobber(0))},100))};if("temp"==e)return void a("yes");Ext.MessageBox.show({title:"Permanent Block Deletion!",msg:l,width:300,buttons:Ext.MessageBox.OKCANCEL,fn:a,icon:Ext.MessageBox.WARNING})}else i.find(".tinyBlocksRowsWrapperClass").empty(),tinyBlocksThrobber(0)}function tinyBlocksImport(){if($(".tinyBlocksHTMLwrapper:visible").length){tinyBlocksToolsMenu(),tinyBlocksThrobber(1);var e="\\[\\[-"+tinyBlocksProjectNameUC+"]]",t=new RegExp(e,"gi");setTimeout(function(){var e=document.getElementById(tinyBlocksMainWrapperId+"_HTML").value,i=document.getElementById(tinyBlocksMainWrapperId),n=$(i).find(".tinyBlocksRowsWrapperClass");if(tinyBlocksPure)return tinyBlocksThrobber(0),void MODx.msg.alert("Pure Content!","You are currently in '"+tinyBlocksPure+"' mode");if(e.indexOf("[[-"+tinyBlocksProjectNameUC+"]]")>=0||e.indexOf("[[-"+tinyBlocksProjectNameUC+"-SINGLE]]")>=0){var l=tinyBlocksImportWrapper.replace("[[+content]]",e.replace(t,tinyBlocksImportMarker).replace("[[-"+tinyBlocksProjectNameUC+"-SINGLE]]",""));tinyBlocksClearAll("temp"),$(n).hide().html(l),tinyBlocksPrepareTLB($(n).find(".tb-wrapper-tlb")),tinyBlocksPrepareAceBlock($(n).find(".tb-tiny-rc")),tinyBlocksTinyMCE(),tinyBlocksRawCode(),tinyBlocksThrobber(0),$(n).fadeIn()}else tinyBlocksThrobber(0),Ext.MessageBox.show({title:"Import Manager",msg:"<p>Copy [[-"+tinyBlocksProjectNameUC+"]] to wherever you want sections</p><br><p>OR Copy [[-"+tinyBlocksProjectNameUC+"-SINGLE]] to anywhere if you do not want sections</p>",width:400,buttons:Ext.MessageBox.OK})},200)}}function tinyBlocksInsert(e,t){var i;i="shortcut"==e?t:t.attr("data-tinyblocks-trigger");var n=$("[data-tinyblocks="+i+"]").parents(".tinyBlocksRowTempHolderClass").clone(!0,!0),l=n.find(".tb-wrapper-tlb");l.removeAttr("data-tinyblocks").addClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass").prev(".tb-spacer").addClass(tinyBlocksNewBlockClass+" tinyBlocksNewBlockClass"),n.find(".tb-tiny-rc-sub").length&&("undefined"!=typeof ace?n.find(".tb-tiny-rc-sub").uniqueId().parent().addClass("tb-no-ace"):MODx.msg.alert("Alert!","No Ace!"));var a=$("#"+tinyBlocksMainWrapperId+" .mce-tinyBlocksTools").parent(".tinyBlocksRowTempHolderClass");a.hasClass("tb-nested-yes")&&(n.removeClass("tb-nested-no").addClass("tb-nested-yes").prepend("<div class=tb-select title='Drag to Sort; dbl/Click to Toggle Select/All'></div>"),l.hasClass("tb-tiny-rc")||l.find(".tb-tiny-rc").length?l.removeClass("tb-wrapper-tlb tb-unwrap tb-mini tinyBlocksShrinkBlockClass "+tinyBlocksShrinkBlockClass):l.find("[class^=tb-tiny-]").length?l.contents().unwrap():l.removeClass("tb-wrapper-tlb tb-unwrap tb-mini tinyBlocksShrinkBlockClass "+tinyBlocksShrinkBlockClass),n.html(l),a.hasClass("tb-nested-yes")&&n.prepend("<div class=tb-select title='To move use Esc, UP / DOWN arrows; dbl/Click to Toggle Select/All'></div>")),("fc"==tinyBlocksPure||"md"==tinyBlocksPure||"rc"==tinyBlocksPure)&&l.alterClass("tb-tiny-*","").addClass("tb-tiny-"+tinyBlocksPure+" tb-tiny-pure"),"click"==e||"shortcut"==e?a.length?(a.hasClass("tb-nested-no")&&a.children(".tb-wrapper-tlb").addClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass"),$(n).insertAfter(a)):$(n).prependTo(".tinyBlocksRowsWrapperClass"):"drag"==e&&$("#"+tinyBlocksMainWrapperId+" .tb-ui-drag-helper").replaceWith(n),tinyBlocksLoneOrNoBlock(),tinyBlocksTinyMCE(),tinyBlocksRawCode(),tinyBlocksThrobber(0)}function tinyBlocksQuickInsert(e,t){e-=1;var i=$("#blockSnippetBar").find("[data-tinyblocks-trigger]:eq("+e+")"),n=$("<div>").prepend($("#blockSnippetBar").find("[data-tinyblocks]:eq("+e+")").clone().alterClass("tb-*","").removeClass("tinyBlocksShrinkBlockClass "+tinyBlocksShrinkBlockClass).removeAttr("data-tinyblocks data-tb-title").addClass("tb-mini"));n.find(".tb-mini").children().addClass("mceEditable"),n=n.html(),i.length&&(n&&"mini"==t&&"tmpTempEditor"!==tinymce.activeEditor.id?(tinymce.activeEditor.focus(),tinymce.activeEditor.insertContent(n)):t||i.trigger("click")),po=n}function tinyBlocksPrepareTLB(e){e.each(function(){var e="",t=$(this).find("[class^=tb-tiny-]:not(.tb-tiny-rc)");if(t.length&&($(this).addClass("tb-nested-wrapper"),t.wrap("<div class='"+tinyBlocksRowTempHolderClass+" tinyBlocksRowTempHolderClass tb-nested-yes'></div>"),t.parent().prepend($("<div>",{"class":"tb-select tb-nested-yes",title:"To move use Esc, UP / DOWN arrows; dbl/Click to Toggle Select/All"}))),$(this).hasClass("tb-unwrap")){var i=$(this).data("tb-title"),n=$(this).data("tinyblocks"),l=$.grep(this.className.split(" "),function(e){return 0===e.indexOf("tb-")}).join(" ");$(this).alterClass("tb-*","").removeAttr("data-tinyblocks"),e="<div class='"+l+"' data-tinyblocks='"+n+"' data-tb-title='"+i+"'></div>"}else $("#"+tinyBlocksMainWrapperId+" .tb-wrapper-tlb").length>1;var a="<div class='tinyBlocksRowTempHolderClass tb-nested-no "+tinyBlocksRowTempHolderClass+"'>"+e+"</div>";$(this).wrap(a);var o;o=$(this).attr("data-tb-title")?$(this).attr("data-tb-title").replace(/'|\"/g,""):"",$(this).parents(".tinyBlocksRowTempHolderClass").prepend($("<div>",{"class":"tb-select tb-nested-no",title:"Drag to Sort; dbl/Click to Toggle Select/All"}),$('<div class=tb-spacer><div class=tb-name title=Type></div><div class=tb-title title="Edit Title" contenteditable=true>'+o+"</div></div>"))})}function tinyBlocksPrepareAceBlock(e){tinyBlocksPure&&"rc"!=tinyBlocksPure||(e.each(function(){var e,t;"PRE"!==$(this)[0].nodeName?(t=$(this).html().replace(/(?:&amp;gt;|&gt;)/g,">"),e=tinymce.html.Entities.encodeAllRaw(t)):(t=$(this).html(),e=tinymce.html.Entities.decode(t)),$(this).html("<textarea style='display:none;' class='tb-tiny-rc-sub'>"+e+"</textarea>")}),$("#"+tinyBlocksMainWrapperId+" .tb-tiny-rc").addClass("tb-no-ace"))}function tinyBlocksRawCode(){$("#"+tinyBlocksMainWrapperId+" .tb-tiny-rc.tb-no-ace").each(function(){$(this).addClass("tb-custom-ace-parent").removeClass("tb-no-ace");var e=$(this).find(".tb-tiny-rc-sub");e.uniqueId();var t=e.attr("id");e.each(function(){tinyBlocksAceOrCM(t)})})}function tinyBlocksDuplicate(){var e=$("#"+tinyBlocksMainWrapperId+" .mce-tinyBlocksTools").parent(".tinyBlocksRowTempHolderClass");if(e){tinyBlocksToolsMenu(),e.hasClass("tb-nested-no")&&$(".tb-wrapper-tlb").addClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass");var t=e.clone(!0,!0),i=t.find(".tb-wrapper-tlb");e.hasClass("tb-nested-no")&&i.prev(".tb-spacer").addClass(tinyBlocksNewBlockClass,tinyBlocksDuplicateBlockClass+" tinyBlocksNewBlockClass tinyBlocksDuplicateBlockClass"),t.find(".tb-tiny-rc-sub").uniqueId().hide().parents(".tb-tiny-rc").addClass("tb-no-ace"),t.find(".tb-tiny-md").each(function(){var e=$(this).attr("id");$(this).html(tinymce.get(e).getContent({format:"text"}))}),t.find(".ace_wrapper_modx").remove(),t.find("*:not(.tb-title)").removeAttr("id contenteditable style").alterClass("mce*",""),t.hide().insertAfter(e).fadeIn(),tinyBlocksTinyMCE(),tinyBlocksRawCode(),tinyBlocksLoneOrNoBlock(),tinyBlocksThrobber(0)}}function tinyBlocksDelete(){var e=$("#"+tinyBlocksMainWrapperId+" .mce-tinyBlocksTools").parent(".tinyBlocksRowTempHolderClass");if(e.length){var t=e.index()+1,i=function(t){"ok"==t&&(tinyBlocksToolsMenu(),e.find(".mce-content-body").each(function(){$(this).tinymce().remove()}),e.fadeOut().delay(500).remove(),tinyBlocksLoneOrNoBlock())};Ext.MessageBox.show({title:"Permanent Block Deletion!",msg:"This Block (#"+t+") will be removed",width:280,buttons:Ext.MessageBox.OKCANCEL,fn:i,icon:Ext.MessageBox.WARNING})}}function tinyBlocksShortcutJSON(){function e(e){return e=e.replace(/\n\s*$/,"").replace(/\n/g,","),e="["+e+"]",e=tinymce.util.JSON.parse(e)}tinyBlocksShortcut="",tinyBlocksTemplateMenu="",$("#blockSnippetBar").find("[data-tinyblocks-trigger]").each(function(e){e+=1;var t=($(this).attr("data-tinyblocks-trigger"),$(this).text().trim()),i=$(this).data("tinyblocks-trigger");tinyBlocksShortcut+='{text: "'+e+". "+t+'", onclick: function(){tinyBlocksInsert("shortcut","'+i+'")}}\n'}),$("#blockSnippetBar").find(".tb-mini[data-tinyblocks]").each(function(){var e=$(this).attr("data-tinyblocks"),t=$("#blockSnippetBar").find("[data-tinyblocks-trigger="+e+"]").text().trim(),i=$("<div>").prepend($(this).clone().alterClass("tb-*","").removeClass("tinyBlocksShrinkBlockClass "+tinyBlocksShrinkBlockClass).removeAttr("data-tinyblocks data-tb-title").addClass("tb-mini"));i.find(".tb-mini").children().addClass("mceEditable"),i=i.html(),tinyBlocksTemplateMenu+='{title: "'+t+'", content: "'+JSON.stringify(i).slice(1,-1)+'"}\n'}),tinyBlocksShortcut=e(tinyBlocksShortcut),tinyBlocksTemplateMenu=e(tinyBlocksTemplateMenu)}function tinyBlocksUpAndDown(e){tinyBlocksMouseHoverTraffic=1;var t=$("#"+tinyBlocksMainWrapperId+" .mce-tinyBlocksTools").parent(".tinyBlocksRowTempHolderClass");t.hasClass("tb-nested-no")&&($("#"+tinyBlocksMainWrapperId).find(".ui-selected").removeClass("ui-selected"),t.addClass("ui-selected"));var i=t.prev(),n=t.next();t.hasClass("tb-nested-no")&&$("#"+tinyBlocksMainWrapperId+" .tb-wrapper-tlb").addClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass"),"ArrowUp"==e&&i.length?t.insertBefore(i):"ArrowDown"==e&&n.length&&t.insertAfter(n)}function tinyBlocksRecordSequence(){Mousetrap.record(function(e){var t=e.join("").replace(/alt|\+/g,"");$(tinymce.activeEditor.getBody()).hasClass("mce-edit-focus")?tinyBlocksQuickInsert(t,"mini"):tinyBlocksQuickInsert(t)})}function tinyBlocksKeyBoard(){"undefined"==typeof tinyBlocksCustomKeyBoard&&(new Ext.KeyMap(document.body,{key:Ext.EventObject.S,ctrl:!0,fn:function(e,t){t.stopEvent(),tinyBlocksSave()}}),Mousetrap.bindGlobal("option",function(){tinyBlocksRecordSequence()}),Mousetrap.bind(["up","down"],function(e){tinyBlocksUpAndDown(e.code)}),Mousetrap.bind(["1","2","3","4","5","6","7","8","9"],function(e){var t=e.code.substr(e.code.length-1);tinyBlocksQuickInsert(t)}),Mousetrap.bind({"-":function(){$("#"+tinyBlocksMainWrapperId+" .tb-wrapper-tlb").addClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass")},"+":function(){$("#"+tinyBlocksMainWrapperId+" .tb-wrapper-tlb").removeClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass")},a:function(){$("#"+tinyBlocksMainWrapperId+" .tinyBlocksRowTempHolderClass").addClass("ui-selected")},0:tinyBlocksCountAll,b:tinyBlocksDebug,c:tinyBlocksDuplicate,d:tinyBlocksDisable,h:tinyBlocksGuide,"g t":tinyBlocksDefaultGalleryInit,"g 1":tinyBlocksGalleryTinyJSON,"g g":tinyBlocksGallery,"i m":tinyBlocksImport,"r t":function(){tinyBlocksRandomTip&&tinymce.get("tmpTempEditor").windowManager.alert(tinyBlocksRandomTip)},s:tinyBlocksShowHTML,t:tinyBlocksTitle,"del 1":tinyBlocksDelete,"del a":tinyBlocksClearAll,home:function(){$(".tinyBlocksDistraction").length?($(".tinyBlocksDistraction").removeClass("tinyBlocksDistraction"),$("#modx-leftbar:visible").length||$(".x-layout-mini.x-layout-mini-west").trigger("click")):($("#modx-header, #modx-action-buttons, #modx-content, #modx-action-buttons, #modx-resource-tabs .x-tab-panel-header.x-tab-panel-header-noborder.x-unselectable.x-tab-panel-header-plain").addClass("tinyBlocksDistraction"),$("#modx-leftbar:visible").length&&$(".x-layout-mini.x-layout-mini-west").trigger("click"))}}))}function tinyBlocksTempEditorManager(){$("#tmpTempEditor").length||($("body").append("<div id=tmpTempEditor style=display:none;height:0;width:0;opacity:0;visibility:hidden></div>"),tinymce.init({selector:"#tmpTempEditor",skin_url:tinyBlocksTinymceSkinUrl,inline:!0,forced_root_block:"",force_br_newlines:!1,force_p_newlines:!1}))}function tinyBlocksLoneOrNoBlock(){var e=$(".tinyBlocksRowsWrapperClass .tinyBlocksRowTempHolderClass");e.length<2?e.addClass("tb-lone-block"):e.removeClass("tb-lone-block"),$(".tinyBlocksRowsWrapperClass").children(".tinyBlocksRowTempHolderClass").length?tinyBlocksDefaultBlock||$(".tinyBlocksRowsWrapperClass .tb-guide").remove():tinyBlocksDefaultBlock?($(".tinyBlocksRowsWrapperClass").html(tinyBlocksDefaultBlock),tinyBlocksPrepareTLB($(".tinyBlocksRowsWrapperClass .tb-wrapper-tlb")),tinyBlocksPrepareAceBlock($(".tinyBlocksRowsWrapperClass .tb-tiny-rc")),$(".mce-tinyBlocksTools").length&&(tinyBlocksTinyMCE(),tinyBlocksRawCode()),tinyBlocksLoneOrNoBlock()):$(".tinyBlocksRowsWrapperClass").html(tinyBlocksHelp)}function tinyBlocksTitle(){var e=$("#"+tinyBlocksMainWrapperId+" .mce-tinyBlocksTools").parents(".tinyBlocksRowTempHolderClass").find(".tb-wrapper-tlb"),t=$(".mce-tinyBlocksTools").parents(".tinyBlocksRowTempHolderClass").find(".tb-title"),i=function(i,n){"ok"==i&&(n?(n=n.replace(/'|\"/g,""),e.attr("data-tb-title",n),t.text(n)):(e.removeAttr("data-tb-title"),t.text("")))};Ext.MessageBox.prompt("Title","<span id=tb-alert-title>Special weird Characters are removed</span>",i),$(".ext-mb-input").val(e.attr("data-tb-title"))}function tinyBlocksGuide(){Ext.MessageBox.show({title:"Quick Guide and How To",msg:tinyBlocksHelp,width:600,closable:!0,buttons:Ext.MessageBox.OK,icon:Ext.Msg.QUESTION})}function tinyBlocksThrobber(e,t){t=t?t:0,0===e?setTimeout(function(){$("#tinyBlocksThrobber").remove()},t):1==e&&($("#tinyBlocksThrobber").remove(),$("#"+tinyBlocksMainWrapperId).prepend('<div id="tinyBlocksThrobber"></div>'))}function tinyBlocksDebug(){$(".tinyBlocksDebug").length?$(".tinyBlocksDebug:hidden").length?$(".tinyBlocksDebug").fadeIn():$(".tinyBlocksDebug").fadeOut():MODx.msg.alert("Alert!","Debug Info is switched off for this Template")}function tinyBlocksDisable(){var e=function(e){"ok"==e&&(location.href=tinyBlocksThisPageUrl+"&"+tinyBlocksProjectName.toLowerCase()+"=disabled")};Ext.MessageBox.show({title:"Disable "+tinyBlocksProjectName,msg:"This Page is about to Refresh",width:280,buttons:Ext.MessageBox.OKCANCEL,fn:e,icon:Ext.MessageBox.WARNING})}function tinyBlocksShowHTML(){var e=document.getElementById(tinyBlocksMainWrapperId+"_HTML"),t=$(e).parent();$(t).is(":hidden")?$(t).fadeIn():$(t).fadeOut()}function tinyBlocksCountAll(){var e=document.getElementById(tinyBlocksMainWrapperId),t=$(e).find(".tinyBlocksRowTempHolderClass"),i=t.length;i&&tinymce.get("tmpTempEditor").windowManager.alert("Total number of "+tinyBlocksProjectName+": "+i)}function tinyBlocks(e,t,i,n,l,a,o,r,s,c,d,y,u,m,p,g,h,f,b,k){"undefined"==typeof tinyBlocksItems&&(tinyBlocksItems={}),tinyBlocksSourceFeed=tinyBlocksItems.sourceFeed||e,tinyBlocksOriginalSourceId=tinyBlocksItems.originalSourceId||t,tinyBlocksMainWrapperId="tinyBlocksMainWrapperId_"+tinyBlocksOriginalSourceId,tinyBlocksRowClass=tinyBlocksItems.rowClass||i,tinyBlocksRowTempHolderClass=tinyBlocksItems.rowTempHolderClass||n,tinyBlocksRowsWrapperClass=tinyBlocksItems.rowsWrapperClass||l,tinyBlocksNewBlockClass=tinyBlocksItems.newBlockClass||a,tinyBlocksHiddenBlockClass=tinyBlocksItems.hiddenBlockClass||o,tinyBlocksDuplicateBlockClass=tinyBlocksItems.duplicateBlockClass||r,tinyBlocksShrinkBlockClass=tinyBlocksItems.shrinkClass||s,tinyBlocksSaveButtonTpl=tinyBlocksItems.saveButtonTpl||c,tinyBlocksImportWrapper=tinyBlocksItems.importWrapper||d,tinyBlocksImportMarker=tinyBlocksItems.importMarker||y,tinyBlocksDefaultBlock=tinyBlocksItems.defaultBlock||u||"",tinyBlocksDefaultGallery=tinyBlocksItems.defaultGallery||m||"",tinyBlocksPure=tinyBlocksItems.pure||h,tinyBlocksHelp=tinyBlocksItems.help||f,tinyBlocksThisPageUrl=tinyBlocksItems.thisPageUrl||p,tinyBlocksTinymceSkinUrl=tinyBlocksItems.tinymceSkinUrl||g,tinyBlocksRandomTip=tinyBlocksItems.randomTip||b||"",tinyBlocksProjectName=tinyBlocksItems.projectName||k,tinyBlocksProjectNameUC=tinyBlocksProjectName.toUpperCase(),tinyBlocksProjectNameLC=tinyBlocksProjectName.toLowerCase(),tinyBlocksOriginalSourceId&&tinyBlocksMainWrapperId&&tinyBlocksRowClass&&tinyBlocksRowTempHolderClass&&tinyBlocksRowsWrapperClass?(tinyBlocksThrobber(1),$("."+tinyBlocksRowsWrapperClass).addClass("tinyBlocksRowsWrapperClass"),$("<div id=tinyBlocksControlButtonsWrapper></div><div id=tinyBlocksBubbleBar></div>").prependTo("body"),tinyBlocksTempEditorManager(),$("#"+tinyBlocksMainWrapperId).prepend("<div class='tinyBlocksHTMLwrapper' style=display:none><div id='"+tinyBlocksMainWrapperId+"_HTML_btn' class='tinyBlocksHTMLbtn'></div><textarea id='"+tinyBlocksMainWrapperId+"_HTML' class='tinyBlocksHTML'></textarea></div>"),$("#"+tinyBlocksMainWrapperId+"_HTML").val($("#"+tinyBlocksOriginalSourceId).val()),tinyBlocksKeyBoard(),tinyBlocksPrepareTLB($(".tb-wrapper-tlb")),tinyBlocksPrepareAceBlock($(".tb-tiny-rc")),$(tinyBlocksSaveButtonTpl).prependTo("#modx-action-buttons .x-toolbar-left-row"),tinyBlocksLoneOrNoBlock(),tinyBlocksShortcutJSON(),tinyBlocksClickReady=1,$("[data-tinyblocks-trigger]").on("click",function(){tinyBlocksClickReady&&tinyBlocksInsert("click",$(this))}),tinyBlocksDefaultGallery&&$("#tv"+tinyBlocksDefaultGallery).length&&($("#tv"+tinyBlocksDefaultGallery+":visible").addClass("tb-gallery-tv"),$(".tb-gallery-tv").parent().addClass("tb-gallery-tv").attr("data-tb-tv",tinyBlocksDefaultGallery).on("click",function(){popGal("tv"+tinyBlocksDefaultGallery,tinyBlocksProjectName+" Gallery TV")})),tinyBlocksMouseHoverTraffic=0,tinymce.ui.Factory.create({type:"button",text:"Import (i + m) ",classes:"tinyBlocksHTMLTools",onclick:tinyBlocksImport}).renderTo(document.getElementById(tinyBlocksMainWrapperId+"_HTML_btn")),tinymce.ui.Factory.create({type:"menubutton",text:tinyBlocksProjectName,classes:"tinyBlocksButton",icon:"table",tooltip:tinyBlocksProjectName+" Content Manager Main Menu",hidden:!0,autohide:!0,onPostRender:function(){tinyBlocksRandomTip&&$("#tb-random-tip").text(tinyBlocksRandomTip).delay(1400).fadeIn("slow"),$("#tinyBlocksButtonHolder, .mce-tinyBlocksButton").delay(1400).fadeIn("slow")},menu:[{text:"Gallery Manager",classes:"tb-gallery",menu:[{text:"Main Gallery For this Document (g + t)",classes:"tb-tv-gallery",onclick:tinyBlocksDefaultGalleryInit},{text:"Gallery for Current Row/Block (g + 1)",classes:"tb-o-gallery",onclick:tinyBlocksGalleryTinyJSON},{text:"Toggle Global Gallery (g + g)",classes:"tb-gallery",onclick:tinyBlocksGallery}]},{text:"Delete All Rows (del + a)",onclick:tinyBlocksClearAll},{text:"Quick Insert (1 - 9)",menu:tinyBlocksShortcut,classes:"quickInsert",onPostRender:function(){tinyBlocksShortcut.length||$(".mce-quickInsert").remove()}},{text:"Source / Import / Debug, Etc ...",menu:[{text:"Source / Import (s)",onclick:tinyBlocksShowHTML},{text:"Debug Info (b)",classes:"debug",tooltip:"appears in "+tinyBlocksProjectName+" sidebar",onclick:tinyBlocksDebug},{text:"Disable "+tinyBlocksProjectName+" (d)",classes:"disable",onclick:tinyBlocksDisable},{text:"About",onclick:function(){tinymce.get("tmpTempEditor").windowManager.alert(tinyBlocksProjectName+" 3.0-beta1; tinyBlocks.js-beta3; by donShakespeare 2016")}}]},{text:"Help (h)",onclick:tinyBlocksGuide}]}).renderTo(document.getElementById("tinyBlocksButtonHolder")),tinymce.ui.Factory.create({type:"menubutton",hidden:!0,classes:"tinyBlocksTools",onPostRender:function(){tinyBlocksTinyMCE(),tinyBlocksRawCode(),tinyBlocksThrobber(0),tinyBlocksGallery("begin"),$("#"+tinyBlocksMainWrapperId+" .tinyBlocksRowsWrapperClass").sortable({handle:".tb-select.tb-nested-no",placeholder:"ui-state-highlight",helper:"ui-state-helper",cursorAt:{top:15},delay:5,appendTo:document.body,tolerance:"intersect",axis:"y",opacity:.85,start:function(e,t){tinyBlocksClickReady=0,$("body").addClass("ui-drag"),visibleLi=$(".tinyBlocksRowTempHolderClass.ui-selected").length,visibleSelected=$("#"+tinyBlocksMainWrapperId+" .ui-selected:visible").length,visibleSelected>1?(t.item.siblings(".ui-selected").addClass("tinyBlocksEnRouteSibling"),$(".tinyBlocksEnRouteSibling:not(.tb-ui-multiple-select)").hide().wrapAll("<div class='tinyBlocksTempUI' style='display:none' />"),t.item.addClass("tb-ui-multiple-select ui-selected")):t.item.addClass("tb-ui-single-select"),tinyBlocksMouseHoverTraffic=1,t.item.hasClass("tb-nested-yes")?(t.item.parent().find(".tinyBlocksRowTempHolderClass").find("[class^=tb-tiny-]").addClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass"),t.item.parent().css({height:t.item.parent().outerHeight(!0),overflow:"hidden"})):t.item.parent().find(".tinyBlocksRowTempHolderClass").find(".tb-wrapper-tlb").addClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass")},stop:function(e,t){tinyBlocksClickReady=1,tinyBlocksMouseHoverTraffic=0,t.item.parent().removeAttr("style"),t.item.removeAttr("style"),$("body").removeClass("ui-drag");$("#"+tinyBlocksMainWrapperId+" .tinyBlocksRowTempHolderClass").length,$("#"+tinyBlocksMainWrapperId+" .tinyBlocksRowTempHolderClass.ui-selected").length;!$(".tinyBlocksTempUI").find(".tb-ui-multiple-select").length&&$(".tb-ui-multiple-select").length&&($(".tinyBlocksTempUI").insertAfter(".tb-ui-multiple-select"),$(".tinyBlocksTempUI").contents().unwrap(),console.log("TinyBlocks.js expected jQuery UI multiple Select/Sortable behaviour")),$(".tinyBlocksTempUI").find(".tb-ui-multiple-select").length&&($(".tinyBlocksTempUI > .tinyBlocksRowTempHolderClass:not(.tb-ui-multiple-select)").wrapAll("<div class=tinyBlocksTempUItemp />"),$(".tinyBlocksTempUItemp").insertAfter(".tb-ui-multiple-select"),$(".tinyBlocksTempUItemp").contents().unwrap(),$(".tinyBlocksTempUI").contents().unwrap(),console.log("TinyBlocks.js just solved jQuery UI Sortable headache: child containing parent")),$(".tinyBlocksEnRouteSibling").fadeIn().removeClass("tinyBlocksEnRouteSibling"),$(".tb-ui-multiple-select, .tb-ui-single-select").removeClass("tb-ui-multiple-select tb-ui-single-select")},revert:"invalid",revertDuration:50,receive:function(e,t){tinyBlocksInsert("drag",$(t.item))}}).css("position","relative").selectable({filter:".tinyBlocksRowTempHolderClass",cancel:".tb-guide,.tinyBlocksRowTempHolderClass > *"}),$("[data-tinyblocks-trigger]").draggable({connectToSortable:"#"+tinyBlocksMainWrapperId+" .tinyBlocksRowsWrapperClass",helper:function(e){var t=$(e.target).hasClass("ui-draggable")?$(e.target):$(e.target).closest(".ui-draggable");return t.addClass("tb-onRoute").parent().addClass("tb-onRoute"),t.clone().addClass("tb-ui-drag-helper").css({width:t.width()})},revert:"invalid",zIndex:99999,containment:"window",delay:5,cancel:!1,tolerance:"intersect",revertDuration:50,appendTo:document.body,cursorAt:{top:15},scroll:!1,start:function(){tinyBlocksToolsMenu(),$(".tinyBlocksRowsWrapperClass .ui-selected").removeClass("ui-selected"),$("body, #blockSnippetBar").addClass("ui-drag"),tinyBlocksClickReady=0,$("#"+tinyBlocksMainWrapperId+" .tb-wrapper-tlb").addClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass")},stop:function(){$("body, #blockSnippetBar").removeClass("ui-drag"),$(".tb-onRoute").removeClass("tb-onRoute"),tinyBlocksClickReady=1
}}),$("#blockSnippetBar, #blockSnippetBar [data-tinyblocks-trigger]").disableSelection()},menu:[{icon:!1,text:"Duplicate (c)",classes:"tb-duplicate",onclick:tinyBlocksDuplicate,onPostRender:function(){$(".mce-tb-duplicate").parent().addClass("mce-tinyBlocksTools-menu")}},{icon:!1,text:"Delete (del + 1)",classes:"tb-trash",onclick:tinyBlocksDelete},{icon:!1,text:"Resize (all: -/+)",classes:"tb-enlarge",onclick:function(){var e=$("#"+tinyBlocksMainWrapperId+" .mce-tinyBlocksTools").parent(".tinyBlocksRowTempHolderClass").find(".tb-wrapper-tlb");e.hasClass("tinyBlocksShrinkBlockClass")?e.removeClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass"):e.addClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass")}},{icon:!1,text:"Add/edit Title (t)",classes:"tb-title-spacer",onclick:tinyBlocksTitle},{icon:!1,text:"Gallery (g + 1)",classes:"tb-block-gallery",onclick:tinyBlocksGalleryTinyJSON},{icon:!1,text:"Quick Insert (1-9)",classes:"tb-block-shortcut quickInsert",menu:tinyBlocksShortcut,onPostRender:function(){tinyBlocksShortcut.length||$(".mce-quickInsert").remove()}}]}).renderTo(document.getElementById("tinyBlocksControlButtonsWrapper")),$("#"+tinyBlocksMainWrapperId).on("click",".tb-select",function(){if(tinyBlocksClickReady){tinyBlocksMouseHoverTraffic=0;var e=$(this).parent(".tinyBlocksRowTempHolderClass");e.hasClass("ui-selected")?e.removeClass("ui-selected"):e.addClass("ui-selected")}}),$("#"+tinyBlocksMainWrapperId).on("dblclick",".tb-select",function(){if(tinyBlocksClickReady){var e=$(this).parent().parent().find(".tinyBlocksRowTempHolderClass");e.hasClass("ui-selected")?e.removeClass("ui-selected"):e.addClass("ui-selected")}}),$("#"+tinyBlocksMainWrapperId).on("click",".tb-wrapper-tlb, [class^=tb-tiny-]",function(){tinyBlocksMouseHoverTraffic=0;var e=$(this);e.removeClass(tinyBlocksShrinkBlockClass+" tinyBlocksShrinkBlockClass"),setTimeout(function(){e.prev(".tb-spacer").removeClass(tinyBlocksNewBlockClass+" tinyBlocksNewBlockClass")},2500)}),$("#"+tinyBlocksMainWrapperId).on("mouseenter click",".tinyBlocksRowTempHolderClass",function(){0!==tinyBlocksMouseHoverTraffic||$(".mce-tinyBlocksTools-menu:visible").length||($(".mce-tinyBlocksTools").prependTo($(this)).show(),$(".tinyBlocksActive").removeClass("tinyBlocksActive"),$(this).addClass("tinyBlocksActive"))}),$("#"+tinyBlocksMainWrapperId).on("keyup mouseup mousedown mouseleave",".tb-title",function(){var e=$(this).text().replace(/'|\"/g,""),t=$(this).parents(".tinyBlocksRowTempHolderClass").find(".tb-wrapper-tlb");e?t.attr("data-tb-title",e):t.removeAttr("data-tb-title")}),$(document).on("keyup",function(e){27==e.keyCode&&($("#"+tinyBlocksMainWrapperId+" [contenteditable]").blur(),window.getSelection().removeAllRanges())})):MODx.msg.alert("Alert!","An important selector class or id was not supplied")}function download(e,t,i){function n(e){var t=e.split(/[:;,]/),i=t[1],n="base64"==t[2]?atob:decodeURIComponent,l=n(t.pop()),a=l.length,o=0,r=new Uint8Array(a);for(o;a>o;++o)r[o]=l.charCodeAt(o);return new g([r],{type:i})}function l(e,t){if("download"in m)return m.href=e,m.setAttribute("download",f),m.innerHTML="downloading...",u.body.appendChild(m),setTimeout(function(){m.click(),u.body.removeChild(m),t===!0&&setTimeout(function(){s.URL.revokeObjectURL(m.href)},250)},66),!0;var i=u.createElement("iframe");u.body.appendChild(i),t||(e="data:"+e.replace(/^data:([\w\/\-\+]+)/,c)),i.src=e,setTimeout(function(){u.body.removeChild(i)},333)}var a,o,r,s=window,c="application/octet-stream",d=i||c,y=e,u=document,m=u.createElement("a"),p=function(e){return String(e)},g=s.Blob||s.MozBlob||s.WebKitBlob||p,h=s.MSBlobBuilder||s.WebKitBlobBuilder||s.BlobBuilder,f=t||"download";if("true"===String(this)&&(y=[y,d],d=y[0],y=y[1]),String(y).match(/^data\:[\w+\-]+\/[\w+\-]+[,;]/))return navigator.msSaveBlob?navigator.msSaveBlob(n(y),f):l(y);try{a=y instanceof g?y:new g([y],{type:d})}catch(b){h&&(o=new h,o.append([y]),a=o.getBlob(d))}if(navigator.msSaveBlob)return navigator.msSaveBlob(a,f);if(s.URL)l(s.URL.createObjectURL(a),!0);else{if("string"==typeof a||a.constructor===p)try{return l("data:"+d+";base64,"+s.btoa(a))}catch(b){return l("data:"+d+","+encodeURIComponent(a))}r=new FileReader,r.onload=function(){l(this.result)},r.readAsDataURL(a)}return!0}function toggleLiveEdit(e){1==galleryLiveEdit?(galleryLiveEdit=0,e.windowManager.alert("OFF: JSON changes will NOT affect Gallery")):(galleryLiveEdit=1,e.windowManager.alert("ON: JSON changes WILL affect Gallery immediately"))}function pasteSampleCode(e){e.windowManager.confirm("Reset current JSON to sample code, from which you may Rebuild",function(e){e&&(tinymce.get("tinyJSONfield").setContent('[{"Location": "'+TinyJSONGallery.gallery_rel_url+'images/nature/&autoCreateThumb=0&justJSON=1&options=w=178,h=117,zc=t"}]'),galleryModified(1))})}function toggleHelpInstructions(){$("#gallHelp:hidden").length?$("#gallHelp").css("display","block !important").fadeIn():$("#gallHelp").css("display","none !important").fadeOut()}function rebuildFromCurrent(e,t,i){loadingThrobber(1);var n=tinymce.get("tinyJSONfield").getContent();chunkTransformer(n,t,"",i),runFilter("data-desc")}function rebuildAddFiles(){tinymce.get("tmpTempEditor").windowManager.open({title:"Add Images",classes:"gal-add-images",onSubmit:rebuildGalleryAddFiles,body:[{type:"container",html:"<div style='width:400px;font-size:90%!important;white-space: normal !important'>- dblclick overlay to access File Tree, then hover images of choice to fill focused field; hit tab to move quickly to next field<br><br>- dblclick input field to access File Browser, then select image to fill field</div>"},{type:"textbox",autofocus:!0},{type:"textbox"},{type:"textbox"},{type:"textbox"},{type:"textbox"},{type:"textbox"},{type:"textbox"},{type:"textbox"},{type:"textbox"},{type:"textbox"}]})}function rebuildLocation(e,t){var i,n,l;if(e)n=e,l=n.split("&");else if(tinymce.get("tinyJSONfield")&&(i=tinymce.get("tinyJSONfield").getContent()),n=tinyJSONGalleryDirLocation,l=n.split("&"),i&&qcJSON(i)){JSON.parse(i,function(e,t){"Location"===e&&(n=t.replace(/&amp;/g,"&"))})}return"url"==t?n=l[0]:"thumb"==t?n="1"==rebuildLocation("","auto")?"thumb/":"":"auto"==t?(n=l[1].split("autoCreateThumb="),n=n[1]):"just"==t?(n=l[2].split("justJSON="),n=n[1]):"options"==t&&(n=l[3].split("options="),n=n[1]),n}function rebuildFromMODxTree(e,t){tinymce.get("tinyJSONfield").windowManager.confirm('Use thumbnails in your "thumb/" folder for this Gallery View?',function(i){$("#"+t).parent().parent("ul").find("> li").find("> .x-tree-node-leaf:first-child").addClass("gal-ready-tree");i?rebuildGalleryFromMODX(e,".gal-ready-tree","tree","on"):rebuildGalleryFromMODX(e,".gal-ready-tree","tree","off")})}function rebuildGalleryAddFiles(){var e=tinymce.get("tinyJSONfield"),t="[",i="",n=MODx.config.base_url+$(".mce-tinyJSONfolder").val(),l=$("#list_to_filter li img").length||0;$(".mce-gal-add-images input:visible").each(function(){var e=$(this).val();l++,e&&(t+=i+'{"id":"'+e+'","title":"'+e+'","folder":"'+n+'","hidden":"0","desc":"'+e+'","index":"'+l+'","tag":"","lerror":"0"}',i=",")}),t+="]";var a=JSON.parse(e.getContent()),o=JSON.parse(t),r=a.concat(o);e.setContent(JSON.stringify(r)),rebuildFromCurrent(e,tinyBlocksDefaultGallery),galleryModified(1)}function rebuildGalleryFromMODX(e,t,i,n){fthumb="on"==n?1:0;var l,a,o="",r=tinymce.get("tinyJSONfield");"browser"==i?($(".mce-tinyJSONfolder").removeAttr("data-node-id"),l=e.fullRelativeUrl):l=e;var s=MODx.config.base_url+l,c=l,d=1;s=s.substring(0,s.lastIndexOf("/")+1),c=c.substring(0,c.lastIndexOf("/")+1);var y='[{"Location": "'+c+"&autoCreateThumb="+fthumb+'&justJSON=1&options=w=178,h=117,zc=t"},';$(".mce-tinyJSONfolder").val(c),$(t).each(function(){if("browser"==i)a=this.id;else{var e=$(this).attr("ext:tree-node-id");a=e.substring(e.lastIndexOf("/")+1)}y+=o+'{"id":"'+a+'","title":"'+a+'","folder":"'+s+'","hidden":"0","desc":"'+a+'","index":"'+d+'","tag":"","lerror":"0"}',o=",",d++}).removeClass("gal-ready-tree"),y+="]",r.setContent(y),rebuildFromCurrent(r,tinyBlocksDefaultGallery,n),galleryModified(1)}function rebuildFromServer(e){var t=tinymce.get("tinyJSONfield").getContent();if(tinyJSONGalleryDirLocation="",t){JSON.parse(t,function(e,t){"Location"===e&&(tinyJSONGalleryDirLocation=t.replace(/&amp;/g,"&"),$("#tinyJSONLocationSettings").html("<b>Your current location and setting:</b><br><i>"+tinyJSONGalleryDirLocation+"</i><br><br>"))})}tinyJSONGalleryDirLocation?e.windowManager.confirm("Rebuild, really?",function(t){t&&(loadingThrobber(1),e.windowManager.open({title:"Data from Server",width:410,height:400,url:TinyJSONGallery.gallery_url+"php/TinyJSONGalleryConnector.php?path="+tinyJSONGalleryDirLocation}))}):e.windowManager.alert("Invalid or no JSON in code textarea")}function addCommas(e){e=String(e);for(var t=/(\d+)(\d{3})/;t.test(e);)e=e.replace(t,"$1,$2");return e}function tinyDesc(){tinymce.init({selector:".mce-newDesc",fixed_toolbar_container:"#tinyBlocksBubbleBar",skin_url:TinyJSONGallery.tinymce_skin_url,menubar:!1,plugins:"bubbleBar contextmenu code",toolbar:"code undo redo bold italic underline ",forced_root_block:"",inline:!0,contextmenu:"code undo redo bold italic underline ",setup:function(e){e.on("change keyup",function(){$(".mce-srcC").parents("li").find("a").attr("data-desc",$(e.getBody()).html()),galleryModified(1)})}})}function nextPrevSubmit(e,t){e.attr({href:$(".mce-newLink").val(),"data-id":$(".mce-newId").val(),"data-src":$(".mce-newSrc").val(),"data-index":$(".mce-newIndex").val(),"data-title":$(".mce-newTitle").val(),"data-tag":$(".mce-newTag").val(),"data-desc":$(".mce-newDesc").val()}).children("img").attr("src",TinyJSONGalleryBase+rebuildLocation("","url")+rebuildLocation("","thumb")+$(".mce-newId").val()+"?c="+Math.random()).parents("li").find(".imageIndex").html($(".mce-newIndex").val()).parents("li").find(".twgTitle").html($(".mce-newTitle").val()).parents("li").find(".tagger").attr("data-tag",$(".mce-newTag").val()).html($(".mce-newTag").val()),$("#tinyTIP img").attr("src",TinyJSONGalleryBase+rebuildLocation("","url")+$(".mce-newId").val()+"?c="+Math.random()),t&&($(".allSRC").removeClass("allSRC"),$(".thisSRC").removeClass("thisSRC"))}function myColorbox(){$("#list_to_filter li a").colorbox({rel:"li a",current:!1,opacity:.8,transition:"none",reposition:!0,speed:100,scalePhotos:!1,overlayClose:!1,maxWidth:.93*$(window).width(),maxHeight:.93*$(window).height(),title:!1,onOpen:function(){$("#tinyOverlay").fadeIn(),cSet=0,$("#tinyG").length||($("body").append('<div id="tinyG"><div id="tinyGinner"><span id="cindex" data-label="index #:" class="tinyCs"></span><span id="ctitle" data-label="title:" class="tinyCs"></span><span id="ctag" data-label="tag:" class="tinyCs"></span><div id="cdesc" data-label="desc:" class="tinyCs"></div></div></div>'),$("#cboxOverlay").replaceWith('<div id="tinyOverlay"></div>'),$("#tinyG").hide(),setTimeout(function(){tinymce.init({selector:".tinyCs",skin_url:TinyJSONGallery.tinymce_skin_url,inline:!0,forced_root_block:"",force_br_newlines:!0,force_p_newlines:!1,menubar:!1,toolbar:!1,setup:function(e){e.on("change",function(){galleryModified(1)}),e.on("keyup",function(){"ctitle"==e.id&&($($this).attr("data-title",$("#"+e.id).text().trim()),$($this).parent("li").find(".twgTitle").html($("#"+e.id).text().trim())),"ctag"==e.id&&($($this).attr("data-tag",$("#"+e.id).text().trim()),$($this).parent("li").find(".tagger").attr("data-tag",$("#"+e.id).text().trim()).html($("#"+e.id).text().trim())),"cindex"==e.id&&($($this).attr("data-index",$("#"+e.id).text().trim()),$($this).parent("li").find(".imageIndex").html($("#"+e.id).text().trim())),"cdesc"==e.id&&$($this).attr("data-desc",$("#"+e.id).text().trim())})}})},700)),$("#tinyG").fadeIn(),$("#colorbox").draggable({handle:"#cboxWrapper",cancel:"#cboxCurrent, #cboxTitle",stop:function(){cSet=1,cLeft=$("#colorbox").css("left"),cTop=$("#colorbox").css("top")}})},onCleanup:function(){$("#tinyG").fadeOut(),$("#tinyOverlay").fadeOut(),cSet=cLeft=cTop=null},onComplete:function(){$("#tinyOverlay").on("click",function(){$("#tinyOverlay").fadeOut()}),$("#colorbox").removeAttr("tabindex"),1==cSet&&$("#colorbox").css({top:cTop,left:cLeft}),$("#cboxError").length?$($this).attr("data-lerror",1).addClass("missingLarge"):$($this).attr("data-lerror",0).removeClass("missingLarge")},onLoad:function(){$this=this,$("#cindex").html($($this).attr("data-index")),$("#ctitle").html($($this).attr("data-title")),$("#ctag").html($($this).attr("data-tag")),$("#cdesc").html($($this).attr("data-desc"))}})}function chunkTransformer(e,t,i,n){var l;"on"==n?(n=1,l="thumb/"):"off"==n?(n=0,l=""):"thumb/"==rebuildLocation("","thumb")?(n=1,l="thumb/"):(n=0,l="");var a=[{tag:"li","class":function(e){return 1==e.hidden?"galhidden":void 0},children:[{tag:"a",href:"${folder}${id}","class":function(e){return 1==e.lerror?"missingLarge":void 0},"data-id":"${id}","data-title":"${title}","data-hidden":"${hidden}","data-src":"${folder}${id}","data-desc":"${desc}","data-index":"${index}","data-tag":"${tag}","data-terror":"","data-lerror":"${lerror}","data-ext":function(e){return e.id.split(".").pop().split(".").pop()},children:[{tag:"img",src:"${folder}"+l+"${id}?c="+Math.random(),onerror:function(){$(this).parent().attr("data-terror",1).addClass("missingThumb")},onload:function(){$(this).parent().attr("data-terror",0).removeClass("missingThumb")}}]},{tag:"span","class":"imageIndex",html:"${index}"},{tag:"p","class":"twgTitle",html:"${title}"},{tag:"p","class":"tagger","data-tag":"${tag}",html:"${tag}"}]}];if(e)if(qcJSON(e)){var o="&autoCreateThumb="+n,r=JSON.parse(e,function(e,t){return"Location"===e&&(t=t.replace(/&amp;/g,"&").replace("&autoCreateThumb=1",o).replace("&autoCreateThumb=0",o),jjj=t,tinyJSONGalleryDirLocation=t,$("#tinyJSONLocationSettings").html("<b>Your current location and setting:</b><br><i>"+tinyJSONGalleryDirLocation+"</i><br><br>"),$(".mce-tinyJSONfolder").val(rebuildLocation("","url"))),tinymce.get("tinyJSONfield").setContent(JSON.stringify(t)),t});r.shift(),$("#picSettings").hide().appendTo("#tinyJSONGalleryWrapper"),$("#list_to_filter").empty().json2html(r,a),myColorbox(),mySorted(),$("#list_to_filter").children().length||1===i||tinymce.get("tmpTempEditor").windowManager.alert("Insufficient Data to build Image Gallery"),loadingThrobber(0,3e3)}else tinymce.get("tmpTempEditor").windowManager.alert("Sorry, there is a problem with your JSON"),$("#tinyJSONfieldWrapper").fadeIn();else e='[{"Location": "'+TinyJSONGallery.gallery_rel_url+'images/nature/&autoCreateThumb=0&justJSON=1&options=w=178,h=117,zc=t"}]',tinyJSONGalleryDirLocation=TinyJSONGallery.gallery_rel_url+"images/nature/&autoCreateThumb=0&justJSON=1&options=w=178,h=117,zc=t",$(".mce-tinyJSONfolder").val(rebuildLocation("","url")),setTimeout(function(){$("#"+t).val(e).change(),tinymce.get("tinyJSONfield").setContent(e),tinymce.get("tmpTempEditor").windowManager.alert("Insufficient Data (empty) to build Gallery")},500);$("#list_to_filter li img").length<1&&$("#tinyJSONfield").length,loadingThrobber(0,500)}function galleryModified(e){0===e?$(".mce-closeGal").removeClass("mce-modified"):$(".mce-closeGal").addClass("mce-modified")}function updateChunk(e,t,i){if("undefined"==typeof tinyJSONGalleryDirLocation)return tinymce.get("tmpTempEditor").windowManager.alert("Your JSON's first line is invalid"),loadingThrobber(0),!1;var n=[{Location:tinyJSONGalleryDirLocation}];$("#list_to_filter li a").each(function(){var e={id:$(this).attr("data-id"),title:$(this).attr("data-title"),folder:TinyJSONGalleryBase+rebuildLocation("","url"),desc:$(this).attr("data-desc"),hidden:$(this).attr("data-hidden"),lerror:$(this).attr("data-lerror"),tag:$(this).attr("data-tag"),index:$(this).attr("data-index")};n.push(e)}),1==beautifyJSON?($("#"+t).val(JSON.stringify(n,null,4)).change(),tinymce.get("tinyJSONfield").setContent(JSON.stringify(n,null,4)),galleryModified(0)):($("#"+t).val(JSON.stringify(n)).change(),tinymce.get("tinyJSONfield").setContent(JSON.stringify(n)),galleryModified(0)),hiddenTVMODX=JSON.stringify(n),$("input#"+t+"[type=hidden]").length&&!$("input#"+t+"[type=hidden]").hasClass("gallery-set-aside")&&($("input#"+t+"[type=hidden]").addClass("gallery-set-aside"),Ext.get(t).set({value:JSON.stringify(n)}),MODx.fireResourceFormChange(),MODx.on("ready",function(){Ext.get(t).set({value:JSON.stringify(n)}),MODx.fireResourceFormChange();var e=MODx.load({xtype:"hidden",applyTo:t,value:hiddenTVMODX,listeners:{change:{fn:MODx.fireResourceFormChange,scope:this}}});console.log("hidddddddd");var i=Ext.getCmp("modx-panel-resource");i&&(i.add(e),i.doLayout())})),e?($("#modx-abtn-save button").trigger("click"),setTimeout(function(){galleryModified(0)},2e3)):(loadingThrobber(0),tinymce.get("tmpTempEditor").windowManager.alert("Image Data Updated"),galleryModified(0)),"closePopGal"==i&&tjgClosePopGal()}function saveChunk(e,t,i){if($("#list_to_filter li a:hidden").length){var n=$("#list_to_filter li a:hidden").length;tinymce.get("tmpTempEditor").windowManager.confirm("Filtered images ("+n+") will be marked as hidden, proceed?",function(n){n?($("#list_to_filter li a:hidden").each(function(){$(this).attr("data-hidden",1),$(this).parent("li").addClass("galhidden")}),updateChunk(e,t,i)):loadingThrobber(0)})}else updateChunk(e,t,i)}function runFilter(e){$("#filter_input").val("").change();var t=$(".num_displayed");$("#filter_input").fastLiveFilter(e,"#list_to_filter",{callback:function(e){t.html(addCommas(e)+"<br>"+$("#list_to_filter li").length)}})}function mySorted(){$("#list_to_filter").sortable({handle:"a",placeholder:"ui-state-highlight",start:function(e,t){visibleLi=$("#list_to_filter li:visible").length,visibleSelected=$("#list_to_filter .ui-selected:visible").length,visibleSelected>1?(t.item.siblings(".ui-selected").addClass("galleryEnRouteSibling"),$(".galleryEnRouteSibling:not(.gal-ui-multiple-select)").hide().wrapAll("<div class='galleryTempUI' style='display:none' />"),t.item.addClass("galleryEnRouteMaster gal-ui-multiple-select ui-selected")):t.item.addClass("gal-ui-single-select")},stop:function(e,t){!$(".galleryTempUI").find(".gal-ui-multiple-select").length&&$(".gal-ui-multiple-select").length&&($(".galleryTempUI").insertAfter(".gal-ui-multiple-select"),$(".galleryTempUI").contents().unwrap()),$(".galleryTempUI").find(".gal-ui-multiple-select").length&&($(".galleryTempUI > .galleryRowTempHolderClass:not(.gal-ui-multiple-select)").wrapAll("<div class=galleryTempUItemp />"),$(".galleryTempUItemp").insertAfter(".gal-ui-multiple-select"),$(".galleryTempUItemp").contents().unwrap(),$(".galleryTempUI").contents().unwrap()),$(".galleryEnRouteSibling").fadeIn().removeClass("galleryEnRouteSibling"),$(".gal-ui-multiple-select, .gal-ui-single-select").removeClass("gal-ui-multiple-select gal-ui-single-select"),t.item.after(t.item.find("li")),$(".galleryEnRouteSibling").fadeIn().removeClass("galleryEnRouteSibling"),$(".galleryEnRouteMaster").removeClass("galleryEnRouteMaster")},update:function(){galleryModified(1)}}),$("#list_to_filter").selectable({filter:"li",cancel:"a, .twgTitlevent, #picSettings, .twgTitle",selecting:function(){$("#picSettings").attr("id","picSetting").hide(),$(".ui-selectable-helper").addClass("tjg-ui-selectable-helper")},stop:function(){$("#picSetting").attr("id","picSettings")}})}function qcJSON(e){try{JSON.parse(e)}catch(t){return!1}return!0}function tagClickReset(){$("#tagManager .tag span").on("click",function(){runFilter("data-tag"),$("#filter_input").val($(this).text().trim()).change(),$(".mce-ftag").parent().children().removeClass("mce-active"),$(".mce-ftag").addClass("mce-active")})}function tagManager(e){if($("#list_to_filter li a").length)if($("#tagManager").length)$("#tagManager").fadeOut().remove();else{var t="";$("#list_to_filter li a[data-tag]").each(function(){t+=$(this).attr("data-tag")+","});var i=t.split(",").filter(function(e,t,i){return t==i.indexOf(e)}).join(",").replace(/,\s*$/,"");$("<div id='tagManager'></div").prependTo("#tinyJSONGalleryWrapper"),tinymce.ui.Factory.create({type:"textbox",value:i,size:20,classes:"imageTag",button:!1,onPostRender:function(){function t(t){var i=t.replace(/[^a-z0-9\s]/gi,"").replace(/[_\s]/g,""),n=$(".tag span").filter(function(){return $(this).html()===i+"&nbsp;&nbsp;"}).parent().css("background-color");$("#list_to_filter .ui-selected").length?($(".ui-selected, .ui-selected a").attr("data-tag",i),$(".ui-selected .tagger").css("background-color",n).attr("data-tag",i).html(i).fadeIn(),tagClickReset(),runFilter("data-tag"),$("#filter_input").val(i).change(),$(".mce-ftag").parent().children().removeClass("mce-active"),$(".mce-ftag").addClass("mce-active"),$("#tagManager .tag span").each(function(){$(this).html()==t+"&nbsp;&nbsp;"&&$(this).html(i+"&nbsp;&nbsp;")}),galleryModified(1)):($("#tagManager .tag span").each(function(){$(this).html()==t+"&nbsp;&nbsp;"&&$(this).parent().remove()}),e.windowManager.alert("No image selected"))}function i(t){var i=t.replace(/[^a-z0-9\s]/gi,"").replace(/[_\s]/g,"");if($("#list_to_filter li a[data-tag='"+i+"']").length){var n=$("#list_to_filter li a[data-tag="+i+"]").length;e.windowManager.alert("Removed '"+t+"' from "+n+" image(s)"),$("#list_to_filter li a[data-tag='"+i+"'], #list_to_filter a[data-tag='"+i+"']").attr("data-tag",""),$("#list_to_filter .tagger[data-tag='"+i+"']").html(""),tagClickReset(),runFilter("data-tag"),$(".mce-tag").parent().children().removeClass("mce-active"),$(".mce-tag").addClass("mce-active"),galleryModified(1)}}$(function(){$(".mce-imageTag").tagsInput({onAddTag:t,onRemoveTag:i,interactive:!0,width:"auto",removeWithBackspace:!0}),tagClickReset(),$("#tagManager .tag span").each(function(){var e=$(this);$(".tagger").filter(function(){return $(this).html()===e.text().trim()}).css("background-color",e.parent().css("background-color")),$(".tagger").fadeIn()})})}}).renderTo(document.getElementById("tagManager"))}}function imageMenu(e){e.windowManager.open({title:"Image attributes",classes:"imageMenu",onPostRender:function(){$(".mce-imageMenu .mce-close").on("click",function(e){e.preventDefault(),$(".allSRC").removeClass("allSRC"),$(".thisSRC").removeClass("thisSRC")}),$("#list_to_filter li:visible").addClass("allSRC")},onSubmit:function(){galleryModified(1);var t=$(".mce-srcC").parents("li").find("a");return nextPrevSubmit(t),e.windowManager.alert("Attributes updated"),!1},body:[{type:"textbox",label:"Location",disabled:!0,classes:"newFolder",onPostRender:function(){$(".mce-newFolder").val(TinyJSONGalleryBase+rebuildLocation("","url"))}},{type:"textbox",label:"Id",tooltip:"Best left alone!!! image filename + ext",classes:"newId",onPostRender:function(){var e=$(".mce-srcC").parents("li").find("a").attr("data-id");$(".mce-newId").val(e)}},{type:"container",html:"<div id=tinyTIP><img src='about:blank' /><p>All inputs but Description are saved when you hit enter. Description is saved automatically always. Prev and Next buttons save everything automatically and will always trigger modified status.</p></div>",onPostRender:function(){var e=$(".mce-srcC").parents("li").find("a").attr("data-id");$("#tinyTIP img").attr("src",TinyJSONGalleryBase+rebuildLocation("","url")+rebuildLocation("","thumb")+e+"?c="+Math.random())}},{type:"textbox",label:"Index #",classes:"newIndex",onPostRender:function(){var e=$(".mce-srcC").parents("li").find("a").attr("data-index");$(".mce-newIndex").attr("type","number").val(e)}},{type:"textbox",label:"Tag",classes:"newTag",tooltip:"one word without special xters",onPostRender:function(){var e=$(".mce-srcC").parents("li").find("a").attr("data-tag");$(".mce-newTag").css("width",200).val(e)}},{type:"textbox",label:"Title",classes:"newTitle",onPostRender:function(){var e=$(".mce-srcC").parents("li").find("a").attr("data-title");$(".mce-newTitle").val(e)}},{type:"textbox",label:"Description",multiline:!0,classes:"newDesc",minHeight:100,onPostRender:function(){var e=$(".mce-srcC").parents("li").find("a").attr("data-desc");$(".mce-newDesc").val(e)}}],buttons:[{text:"Previous",classes:"prevAttribute",tooltip:"Attributes will be saved",onclick:function(){if(nextPrevSubmit($(".thisSRC a")),$(".thisSRC").prev(".allSRC").length){$(".thisSRC").removeClass("thisSRC").prevAll(".allSRC").eq(0).addClass("thisSRC");var e=$(".thisSRC a");$(".mce-newTitle").val(e.attr("data-title")),$(".mce-newId").val(e.attr("data-id")),$(".mce-newIndex").val(e.attr("data-index")),$(".mce-newTag").val(e.attr("data-tag")),$(".mce-newDesc").val(e.attr("data-desc")),$("#tinyTIP img").attr("src",TinyJSONGalleryBase+rebuildLocation("","url")+rebuildLocation("","thumb")+e.attr("data-id")+"?c="+Math.random()),galleryModified(1)}},onPostRender:function(){$(".mce-popGal #list_to_filter > li").length<2&&$(".mce-prevAttribute, .mce-nextAttribute").parent().parent().hide(),$(".mce-newDesc").on("change keyup",function(){$(".mce-srcC").parents("li").find("a").attr("data-desc",$(".mce-newDesc").val()),galleryModified(1)})}},{text:"Next",classes:"nextAttribute",tooltip:"Attributes will be saved",onPostRender:function(){$(".mce-srcC").parents("li").addClass("thisSRC")},onclick:function(){if(nextPrevSubmit($(".thisSRC a")),$(".thisSRC").next(".allSRC").length){$(".thisSRC").removeClass("thisSRC").nextAll(".allSRC").eq(0).addClass("thisSRC");var e=$(".thisSRC a");$(".mce-newTitle").val(e.attr("data-title")),$(".mce-newId").val(e.attr("data-id")),$(".mce-newIndex").val(e.attr("data-index")),$(".mce-newTime").val(e.attr("data-time")),$(".mce-newTag").val(e.attr("data-tag")),$(".mce-newDesc").val(e.attr("data-desc")),$("#tinyTIP img").attr("src",TinyJSONGalleryBase+rebuildLocation("","url")+rebuildLocation("","thumb")+e.attr("data-id")+"?c="+Math.random()),galleryModified(1)}}}]})}function loadingThrobber(e,t){t=t?t:0,0===e?setTimeout(function(){$("#loadingThrobber").remove()},t):1==e&&($("#loadingThrobber").remove(),$("body").append('<div id="loadingThrobber"></div>'))}function tinyLord(e,t){tinymce.init({name:"tinyFileImageGallery",selector:"#tinyFileImageGallery",skin_url:TinyJSONGallery.tinymce_skin_url,inline:!0,forced_root_block:"",force_br_newlines:!1,force_p_newlines:!1,setup:function(i){i.on("init",function(){$(document).on("mouseenter","#list_to_filter li",function(){$("#picSettings").appendTo($(this).not(".ui-state-highlight")).show()}),tinymce.ui.Factory.create({type:"button",classes:"moreAttr",tooltip:"Enlarge image, hide, delete, edit tags, title and description etc ...",onPostRender:function(){$(".mce-moreAttr").html("<i class='mce-caret'></i>")},onclick:function(){$(".mce-moreAttrMenu:hidden").length?($(".mce-moreAttrMenu").show(),$(".mce-moreAttr").addClass("mce-active")):($(".mce-moreAttrMenu").hide(),$(".mce-moreAttr").removeClass("mce-active"))}}).renderTo(document.getElementById("picSettings")),tinymce.ui.Factory.create({type:"menu",classes:"moreAttrMenu",onPostRender:function(){$(".mce-moreAttrMenu").css("display","block!important")},items:[{tooltip:"Enlarge",icon:"fullscreen",classes:"zoomPic",onclick:function(){$(".mce-zoomPic").parents("li").find("a").trigger("click")}},{tooltip:"Edit all Image Info at once",icon:"image",classes:"srcC",onclick:function(){imageMenu(i)}},{tooltip:"Edit Title(s)",icon:"backcolor",classes:"eTitles",onclick:function(){$(".mce-eTitles").parents("li").addClass("ui-selected"),$(".ui-selected").length?tinymce.init({selector:".ui-selected .twgTitle",skin_url:TinyJSONGallery.tinymce_skin_url,inline:!0,menubar:!1,plugins:"contextmenu",toolbar:!1,forced_root_block:"",contextmenu:"undo redo",setup:function(e){e.on("change keyup",function(){$("#"+e.id).parent("li").find("a").attr("data-title",$(e.getBody()).html()),galleryModified(1)})}}):i.windowManager.alert("No image was selected");var e=$(".ui-selected").length;i.windowManager.alert("Titles made editable: "+e)}},{tooltip:"Hide Image(s)",icon:"preview",classes:"hidePic",onclick:function(){var e=$(".mce-hidePic").parents("li");e.addClass("ui-selected");var t=$(".ui-selected").length;1==$(".ui-selected a").attr("data-hidden")?($(".ui-selected a").attr("data-hidden",0),$(".ui-selected").removeClass("galhidden"),i.windowManager.alert("Images unHidden: "+t),galleryModified(1)):($(".ui-selected a").attr("data-hidden",1),$(".ui-selected").addClass("galhidden"),i.windowManager.alert("Images hidden: "+t),galleryModified(1))}},{tooltip:"Delete Image(s)",icon:"unlink",classes:"delPic",onclick:function(){var e=$(".mce-delPic").parents("li");e.addClass("ui-selected");var t=$(".ui-selected").length;i.windowManager.confirm("Remove "+t+" permanently? (still on server)",function(e){e&&($("#picSettings").appendTo("#tinyJSONGalleryWrapper").hide(),$(".ui-selected").remove(),runFilter("data-desc"),galleryModified(1))})}}]}).renderTo(document.getElementById("picSettings")),tinymce.ui.Factory.create({type:"button",text:"Advanced ",classes:"options gallery",icon:"fullpage",tooltip:"Dig into the Raw Art beneath your gallery",onclick:function(){$("#tinyJSONfield:hidden").length?$("#tinyJSONfieldWrapper").fadeIn():$("#tinyJSONfieldWrapper").fadeOut()},onPostRender:function(){$("#galButtons").hide(),setTimeout(function(){$("#galButtons").css("opacity",1).hide().fadeIn()},500),tinymce.ui.Factory.create({type:"menubutton",text:"START",icon:"browse",onPostRender:function(){$("#tinyJSONfolderWrapper").insertAfter(".mce-popGal .mce-window-head"),setTimeout(function(){$(".mce-popGal").height($(".mce-popGal").outerHeight(!0)+$("#tinyJSONfolderWrapper").outerHeight(!0)),$("#tinyJSONfolderWrapper").hide().delay(3e3).show().css("opacity",1)},500)},menu:[{text:"Create From File Browser ...",tooltip:"Click to open MODX File Browser; SELECT any image to grab entire folder; hit OKAY",onclick:function(){var e=$(".mce-tinyJSONfolder").val()||rebuildLocation("","url"),t=$(".mce-tinyJSONfolder").attr("id");autoFileBrowser(t,e,"","","createGal")}},{text:"Create From File Tree ...",tooltip:"First hover any valid image file in File Tree; then click here to add its folder content",onclick:function(){$("#mce-modal-block:visible").length&&i.windowManager.alert("Dblclick the overlay to access your MODX File Tree"),$(".mce-tinyJSONfolder").attr("data-node-id")||i.windowManager.alert("Please first hover any image in File Tree before clicking here");var e=$(".mce-tinyJSONfolder").val(),t=$(".mce-tinyJSONfolder").attr("data-node-id");e.indexOf("/")>1&&t&&rebuildFromMODxTree(e,t)}},{text:"Add to Existing Gallery ...",tooltip:"Append new images to an existing gallery",onclick:rebuildAddFiles},{text:"Thumbnails",menu:[{text:"Reload Gallery with thumbnails",onclick:function(){rebuildFromCurrent(i,t,"on"),galleryModified(1)}},{text:"Reload Gallery without thumbnails",onclick:function(){rebuildFromCurrent(i,t,"off"),galleryModified(1)}},{text:"Create thumbnails",onclick:function(){tinymce.get("tmpTempEditor").windowManager.open({title:"Create Thumbnails",classes:"gal-creat-thumb",onSubmit:null,body:[{type:"container",html:"<div style='width:600px;font-size:90%!important;white-space: normal !important;text-align:ccenter;'>Images folder</div>"},{type:"textbox",tooltip:"Make sure your image files are not too large",classes:"gal-thumb-main",value:rebuildLocation("","url"),autofocus:!0},{type:"container",html:"<div style='width:600px;font-size:90%!important;white-space: normal !important;text-align:ccenter;'><br><br>(optional) Thumb folder suffix</b></div>"},{type:"textbox",tooltip:'This Gallery View uses only thumbnails found in "thumb/" folder. But for your other purposes you may add a suffix "400x300" to create extra thumbnails in "thumb400x300/"',classes:"gal-thumb-suff",onPostRender:function(){$(".mce-gal-thumb-suff").attr("placeholder","e.g 200x100").css("width","110px!important")}},{type:"container",html:"<div style='width:600px;font-size:90%!important;white-space: normal !important;text-align:ccenter;'><br><br>(optional) Thumbnail settings: <a style=color:#89aaf5; href=https://github.com/modxcms/Resizer#options target=_blank>MODX Resizer</a></div>"},{type:"textbox",tooltip:"w(width), h(height): Comma-separated MODX Resizer options",classes:"gal-thumb-options",value:"w=178,h=117,zc=t"}],buttons:[{text:"Create",onclick:function(){var e=$(".mce-gal-thumb-main").val()+"&autoCreateThumb=1&justJSON=0&doThumbs=1&thumbFldSuffix="+$(".mce-gal-thumb-suff").val()+"&options="+$(".mce-gal-thumb-options").val();
i.windowManager.open({title:"Thumbnails Creation ...",width:410,height:200,url:TinyJSONGallery.gallery_url+"php/TinyJSONGalleryConnector.php?path="+e})}}]})}}]},{text:"Save Visual Changes ",onclick:function(){loadingThrobber(1),saveChunk("",t)}},{text:"More ...",menu:[{text:"Select All (visible items)",icon:"table",onclick:function(){$(".ui-selected").removeClass("ui-selected"),$("#list_to_filter li:visible").addClass("ui-selected")}},{text:"Reindex according to position",icon:"numlist",onclick:function(){i.windowManager.confirm("Really? this will overwrite the initial index derived from your server",function(e){e&&$("#list_to_filter li").each(function(){$(this).find(".imageIndex").html($(this).index()+1),$(this).find("a").attr("data-index",$(this).index()+1),galleryModified(1)})})}},{text:"Restore Gallery",icon:"undo",onclick:function(){i.windowManager.confirm("You'll lose any changes, proceed?",function(i){i&&($("#"+t).val(e).change(),tinymce.get("tinyJSONfield").setContent(e),chunkTransformer(e,t),runFilter("data-desc"),galleryModified(0))})}}]}]}).renderTo(document.getElementById("tinyJSONfolderWrapper")),tinymce.ui.Factory.create({type:"textbox",style:"width:80%",tooltip:"Relative URLs only! The address here will be used to generate and maintain your gallery",classes:"tinyJSONfolder",onPostRender:function(){$(".mce-tinyJSONfolder").on("keyup",function(e){return 13==e.keyCode?(e.preventDefault(),!1):void 0})},value:rebuildLocation("","url")}).renderTo(document.getElementById("tinyJSONfolderWrapper")),tinymce.ui.Factory.create({type:"button",text:"Tags",icon:"anchor",tooltip:'Toggle/Refresh Tags. Clear "Live filter search" to see all tags',classes:"tagger gallery",onclick:function(){tagManager(i)}}).renderTo(document.getElementById("galButtons")),tinymce.ui.Factory.create({type:"button",text:" Filter",icon:"searchreplace",classes:"fastFilter gallery",onPostRender:function(){$(".mce-fastFilter").addClass("extraFilth").removeAttr("id"),$(".extraFilth").html("<span class='num_displayed' title='Images displayed'></span><span id='filter_reset' title='reset search'>X</span><input id='filter_input' placeholder='Live filter search' value=''> "),runFilter("data-tag"),$("#filter_reset").on("click",function(){$("#filter_input").val("").change()})}}).renderTo(document.getElementById("galButtons")),tinymce.ui.Factory.create({type:"splitbutton",text:!1,classes:"gallery splitMe",onPostRender:function(){$(".mce-splitMe button:first-child").hide(),$(".mce-alt").parent().addClass("splitMeparent")},menu:[{text:"Filter by Tag/Category",classes:"ftag",active:!0,onclick:function(){$(".mce-ftag").parent().children().removeClass("mce-active"),$(".mce-ftag").addClass("mce-active"),runFilter("data-tag")}},{text:"Filter by Extension",classes:"ext",onclick:function(){$(".mce-ext").parent().children().removeClass("mce-active"),$(".mce-ext").addClass("mce-active"),runFilter("data-ext")}},{text:"Filter by Img Desc",classes:"desc",onclick:function(){$(".mce-desc").parent().children().removeClass("mce-active"),$(".mce-desc").addClass("mce-active"),runFilter("data-desc")}},{text:"Filter by Img Index",classes:"index",onclick:function(){$(".mce-index").parent().children().removeClass("mce-active"),$(".mce-index").addClass("mce-active"),runFilter("data-index")}},{text:"Filter by Img Title",classes:"gal-title",onclick:function(){$(".mce-gal-title").parent().children().removeClass("mce-active"),$(".mce-gal-title").addClass("mce-active"),runFilter("data-title")}},{text:"Filter by Hidden/Visible (1/0)",classes:"hidden",onclick:function(){$(".mce-hidden").parent().children().removeClass("mce-active"),$(".mce-hidden").addClass("mce-active"),runFilter("data-hidden"),$("#filter_input").val(1).change()}},{text:"Filter by Missing Thumb (1/0)",classes:"terror",onclick:function(){$(".mce-terror").parent().children().removeClass("mce-active"),$(".mce-terror").addClass("mce-active"),runFilter("data-terror"),$("#filter_input").val(1).change()}},{text:"Filter by Missing Image (1/0)",classes:"lerror",onclick:function(){$(".mce-lerror").parent().children().removeClass("mce-active"),$(".mce-lerror").addClass("mce-active"),runFilter("data-lerror"),$("#filter_input").val(1).change()}}]}).renderTo(document.getElementById("galButtons")),tinymce.ui.Factory.create({type:"menubutton",text:"Sort ",icon:"pagebreak",classes:"sort gallery",menu:[{text:"Sort Order",classes:"sdir",menu:[{text:"Ascend",active:!0,classes:"sasc",onclick:function(){$(".mce-sasc").parent().children().removeClass("mce-active"),$(".mce-sasc").addClass("mce-active"),sortDir="asc"}},{text:"Descend",classes:"sdesc",onclick:function(){$(".mce-sdesc").parent().children().removeClass("mce-active"),$(".mce-sdesc").addClass("mce-active"),sortDir="desc"}},{text:"Random",classes:"srand",onclick:function(){$(".mce-srand").parent().children().removeClass("mce-active"),$(".mce-srand").addClass("mce-active"),sortDir="rand"}}]},{text:"Sort by Img Desc",classes:"sdescr",onclick:function(){$(".mce-sdescr").parent().children().removeClass("mce-active"),$(".mce-sdescr").addClass("mce-active"),tinysort("#list_to_filter>li",{selector:"a:not([class=fHidden])",attr:"data-desc",order:sortDir}),galleryModified(1)}},{text:"Sort by Img Title",classes:"stitle",onclick:function(){$(".mce-stitle").parent().children().removeClass("mce-active"),$(".mce-stitle").addClass("mce-active"),tinysort("#list_to_filter>li",{selector:"a:not([class=fHidden])",attr:"data-title",order:sortDir}),galleryModified(1)}},{text:"Sort by Index #",classes:"sindex",active:!0,onclick:function(){$(".mce-sindex").parent().children().removeClass("mce-active"),$(".mce-sindex").addClass("mce-active"),tinysort("#list_to_filter>li",{selector:"a:not([class=fHidden])",attr:"data-index",order:sortDir}),galleryModified(1)}}]}).renderTo(document.getElementById("galButtons")),tinymce.ui.Factory.create({type:"button",text:"Close ",classes:"closeGal gallery",onclick:function(){$(".mce-modified").length?tinymce.get("tmpTempEditor").windowManager.confirm("Save changes before exit?",function(e){e?(loadingThrobber(1),saveChunk("",t,"closePopGal")):tjgClosePopGal()}):tjgClosePopGal()}}).renderTo(document.getElementById("galButtons")),scriptLoader.loadQueue(function(){chunkTransformer(e,t,1)})}}).renderTo(document.getElementById("galButtons")),$(".mce-gallery").delay(1700).fadeIn()})}})}function tinyGalleryInit(e){var t;if($("#"+e).length){t=$("#"+e).val();var i=$("#"+e).val();sortDir="asc",beautifyJSON=0,tinymce.init({name:"gallery",selector:"#tinyJSONfield",skin_url:TinyJSONGallery.tinymce_skin_url,toolbar:!1,menubar:!1,hidden_input:!1,entity_encoding:"raw",apply_source_formatting:!1,cleanup:!1,inline:!0,plugins:"paste, contextmenu, code, save, searchreplace",contextmenu:" buildFromServer buildFromTextarea | toggleLive saveData | pasteSample | exportJSON | searchreplace toggleHelp",forced_root_block:"",force_br_newlines:!1,force_p_newlines:!1,valid_elements:"grt",body_id:"mce-tinyJSONGallery",paste_as_text:!0,save_enablewhendirty:!0,setup:function(t){t.addMenuItem("buildFromServer",{text:"* Build JSON/Thumbnails From Server",onclick:function(){rebuildFromServer(t)}}),t.addMenuItem("buildFromTextarea",{text:"* Build Gallery From JSON",onclick:function(){rebuildFromCurrent(t,e)}}),t.addMenuItem("saveData",{text:"Save Gallery changes to JSON",onclick:function(){loadingThrobber(1),saveChunk("",e)}}),t.addMenuItem("toggleHelp",{text:"Toggle Help and Brief Instructions",onclick:function(){toggleHelpInstructions()}}),t.addMenuItem("pasteSample",{text:"Paste Sample JSON Code",onclick:function(){pasteSampleCode(t)}}),t.addMenuItem("toggleLive",{text:"Live Edit: JSON => GUI",onclick:function(){toggleLiveEdit(t)}}),t.addMenuItem("exportJSON",{text:"View Friendly Data",menu:[{text:"Pop it right here",onclick:function(){var e=JSON.parse(tinymce.get("tinyJSONfield").getContent());e=JSON.stringify(e,null,2),alert(e)}},{text:"Download to your computer",onclick:function(){var t=JSON.parse(tinymce.get("tinyJSONfield").getContent());t=JSON.stringify(t,null,2),download(t,"gallery-"+e+".json")}}]}),t.on("init",function(){galleryJSONchanged=0,galleryLiveEdit=0,t.setContent(i)}),t.on("change keyup",function(){galleryModified(1),0===galleryJSONchanged&&($("#tinyJSONfolder:visible").length&&t.windowManager.alert('When done editing, please "Build Gallery From JSON" before saving'),galleryJSONchanged=1),1==galleryLiveEdit&&chunkTransformer(t.getContent(),e)}),t.on("blur",function(){1==galleryLiveEdit&&chunkTransformer(t.getContent(),e)})}})}else setTimeout(function(){tinymce.get("tmpTempEditor").windowManager.alert("Input field with id: "+e+" does not exist")},200);$("#"+e).attr({placeholder:"Enter valid JSON"}),loadingThrobber(1),tinyLord(t,e)}function tradGal(e,t){notApplicableToAppToGal=0,t=t,$("#tinyJSONGalleryWrapper, #galButtons, #galButtonsTemp, #tinyTemp, #tvChunkGalleries-notice").remove(),$(".tvChunkGalleries-parent").removeClass("tvChunkGalleries-parent"),1==e?($("#tinyJSONGalleryWrapperEXtJS").append("<div id=tvChunkGalleries-notice>"+tvChunkGalleriesNotice+"</div>"),tinymce.EditorManager.execCommand("mceRemoveEditor",!0,"tinyFileImageGallery"),tinymce.EditorManager.execCommand("mceRemoveEditor",!0,"tinyJSONfield"),$('<div id="tinyTemp" style="display:none!important;border:0!important;outline:0!important;width:0;height:0;"></div><div id="galButtonsTemp" class="galButtons" style="opacity:1!important"></div>').prependTo(tinyJSONGalleryGalButtons),tinymce.init({selector:"#tinyTemp",inline:!0,toolbar:!1,menubar:!1,skin_url:TinyJSONGallery.tinymce_skin_url}),tinymce.ui.Factory.create({type:"button",text:"Restore Main Gallery",classes:"options gallery",icon:"fullpage",tooltip:"Restore Gallery to this page, and turn off double-click effect",onclick:function(){exitedGalleryToUseElementTree=0,tradGal(0,t)}}).renderTo(document.getElementById("galButtonsTemp")),$("#modx-tv-tabs textarea:not(.modx-richtext)").addClass("tvJSONGalleries"),$(document).on("mouseenter",".modx-window, .tvJSONGalleries",function(){var e,t;$(this).hasClass("tvJSONGalleries")?(1==exitedGalleryToUseElementTree&&$(".tvJSONGalleries").parent().addClass("tvChunkGalleries-parent"),e=" TV: "+$(this).parents(".modx-tv").find(".modx-tv-caption").text(),t=$(this).attr("id"),$(this).on("dblclick",function(){t&&1==exitedGalleryToUseElementTree&&!$("#tinyJSONGalleryWrapper").length&&popGal(t,tinyJSONGalleryTABtitle+e)})):(1==exitedGalleryToUseElementTree&&$(this).find("textarea[name=snippet]").parents(".modx-window").addClass("tvChunkGalleries-parent"),$(this).find("textarea[name=snippet]").addClass("chunkJSONGalleries"),t=$(this).find("textarea[name=snippet]").attr("id"),e=" Chunk: "+$(this).find(".x-window-header-text > span").text(),$(this).find(".chunkJSONGalleries").on("dblclick",function(){t&&1==exitedGalleryToUseElementTree&&!$("#tinyJSONGalleryWrapper").length&&popGal(t,tinyJSONGalleryTABtitle+e)}))})):($('<div id="tinyJSONGalleryWrapper"><span id="galleryContextmenuNotice"></span><div id="tinyJSONfield" title="Access  quick options via Context Menu"></div><div id="tinyJSONGalleryStation"><div id="gallHelp">'+tinyJSONgallHelp+'</div><div id=tinyFileImageGallery style=display:none;height:0;width:0;opacity:0;visibility:hidden></div><ol id="list_to_filter" class="grid"></ol><div id="picSettings"></div></div></div>').appendTo("#tinyJSONGalleryWrapperEXtJS"),$('<div id="galButtons" class="galButtons"></div>').prependTo(tinyJSONGalleryGalButtons),tinyGalleryInit(textareaForJSONbk))}function popGal(e,t,i,n,l){var a="";l&&(a=" ("+e+")"),notApplicableToAppToGal=1,!$("#list_to_filter").length&&$("#"+e).length?tinymce.get("tmpTempEditor").windowManager.open({title:t?t+a:"JSON Image Gallery"+a,width:i?i:885,height:n?n:500,classes:"popGal",autoScroll:!0,items:[{classes:"popGallery",type:"container",style:"width:100% !important;height:inherit !important"}],buttons:[{text:"Hidden Toolbar Wrapper",classes:"closeGallery",style:"visibility:hidden;",onPostRender:function(){$(".mce-popGal button.mce-close").remove(),$('<div id="tinyJSONGalleryWrapper"><div id="tinyJSONfolderWrapper"></div><div id=tinyJSONfieldWrapper><span id="galleryContextmenuNotice"></span><div id="tinyJSONfield" title="Access  quick options via Context Menu"></div></div><div id="tinyJSONGalleryStation"><div id="gallHelp">'+tinyJSONgallHelp+'</div><div id=tinyFileImageGallery style=display:none;height:0;width:0;opacity:0;visibility:hidden></div><ol id="list_to_filter" class="grid"></ol><div id="picSettings"></div></div></div>').prependTo(".mce-popGallery > .mce-container-body"),$('<div id="tinyJSONGalleryBAR"><div id="galButtons" class="galButtons"></div></div>').insertBefore(".mce-closeGallery"),tinyGalleryInit(e)}}]}):tinymce.get("tmpTempEditor").windowManager.alert("Invalid operation")}function tjgClosePopGal(){tinymce.EditorManager.execCommand("mceRemoveEditor",!0,"tinyFileImageGallery"),tinymce.EditorManager.execCommand("mceRemoveEditor",!0,"tinyJSONfield"),tinymce.get("tmpTempEditor").windowManager.close()}function createTempEditorManager(){$("#tmpTempEditor").length||($("body").append("<div id=tmpTempEditor style=display:none;height:0;width:0;opacity:0;visibility:hidden></div>"),tinymce.init({selector:"#tmpTempEditor",skin_url:TinyJSONGallery.tinymce_skin_url,inline:!0,forced_root_block:"",force_br_newlines:!1,force_p_newlines:!1}))}function mainStreamer(e){tinymce.get("tmpTempEditor").windowManager.close(),tinymce.get("tmpTempEditor").windowManager.close(),$("body").append("<div style='background:#fff;position:fixed;z-index:999999;top:20%;width:50%;height:40%;left:0;right:0;margin:auto'>"+e+"</div>"),tinymce.get("tmpTempEditor").windowManager.close()}!function(e){jQuery.fn.clone=function(){for(var t=e.apply(this,arguments),i=this.find("textarea").add(this.filter("textarea")),n=t.find("textarea").add(t.filter("textarea")),l=this.find("select").add(this.filter("select")),a=t.find("select").add(t.filter("select")),o=0,r=i.length;r>o;++o)$(n[o]).val($(i[o]).val());for(o=0,r=l.length;r>o;++o)for(var s=0,c=l[o].options.length;c>s;++s)l[o].options[s].selected===!0&&(a[o].options[s].selected=!0);return t}}(jQuery.fn.clone),$.fn.alterClass=function(e,t){var i=this;if(-1===e.indexOf("*"))return i.removeClass(e),t?i.addClass(t):i;var n=new RegExp("\\s"+e.replace(/\*/g,"[A-Za-z0-9-_]+").split(" ").join("\\s|\\s")+"\\s","g");return i.each(function(e,t){for(var i=" "+t.className+" ";n.test(i);)i=i.replace(n," ");t.className=$.trim(i)}),t?i.addClass(t):i},("undefined"==typeof autoFileBrowser||"modxNativeBrowser"==autoFileBrowser.name)&&(autoFileBrowser=function(e,t,i,n,l){$(".modx-browser").remove();var a;t&&(a=t.substring(0,t.lastIndexOf("/")+1));var o=MODx.load({xtype:"modx-browser",multiple:!0,openTo:a||MODx.config.manager_url+"index.php?a="+MODx.action.browser+"&source="+MODx.config.default_media_source,listeners:{select:{fn:function(t){if("createGal"==l)tinymce.get("tinyJSONfield").windowManager.confirm("Use thumbnails for this Gallery View?",function(e){e?rebuildGalleryFromMODX(t,".modx-browser-thumb-wrap","browser","on"):rebuildGalleryFromMODX(t,".modx-browser-thumb-wrap","browser","off")});else if("addGalFiles"==l){var i=t.fullRelativeUrl;document.getElementById(e).value=i.substring(i.lastIndexOf("/")+1)}else n.document.getElementById(e).value=t.fullRelativeUrl;MODx.fireEvent("select",t)},scope:this}}});o.show()});var json2html={transform:function(e,t,i){var n={events:[],html:""},l={events:!1};if(l=json2html._extend(l,i),void 0!==t||void 0!==e){var a="string"==typeof e?JSON.parse(e):e;n=json2html._transform(a,t,l)}return l.events?n:n.html},_extend:function(e,t){var i={};for(var n in e)i[n]=e[n];for(var n in t)i[n]=t[n];return i},_append:function(e,t){var i={html:"",event:[]};return"undefined"!=typeof e&&"undefined"!=typeof t&&(i.html=e.html+t.html,i.events=e.events.concat(t.events)),i},_isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},_transform:function(e,t,i){var n={events:[],html:""};if(json2html._isArray(e))for(var l=e.length,a=0;l>a;++a)n=json2html._append(n,json2html._apply(e[a],t,a,i));else"object"==typeof e&&(n=json2html._append(n,json2html._apply(e,t,void 0,i)));return n},_apply:function(e,t,i,n){var l={events:[],html:""};if(json2html._isArray(t))for(var a=t.length,o=0;a>o;++o)l=json2html._append(l,json2html._apply(e,t[o],i,n));else if("object"==typeof t&&void 0!==t.tag){var r=json2html._getValue(e,t,"tag",i);l.html+="<"+r;var s,c={events:[],html:""};for(var d in t)switch(d){case"tag":break;case"children":if(json2html._isArray(t.children))c=json2html._append(c,json2html._apply(e,t.children,i,n));else if("function"==typeof t.children){var y=t.children.call(e,e,i);"object"==typeof y?void 0!==y.html&&void 0!==y.events&&(c=json2html._append(c,y)):"string"==typeof y&&(c.html+=y)}break;case"html":s=json2html._getValue(e,t,"html",i);break;default:var u=!1;if(d.length>2&&"on"==d.substring(0,2).toLowerCase()){if(n.events){var m={action:t[d],obj:e,data:n.eventData,index:i},p=json2html._guid();l.events[l.events.length]={id:p,type:d.substring(2),data:m},l.html+=" json2html-event-id-"+d.substring(2)+"='"+p+"'"}u=!0}if(!u){var g=json2html._getValue(e,t,d,i);if(void 0!==g){var h;h="string"==typeof g?'"'+g.replace(/"/g,"&quot;")+'"':g,l.html+=" "+d+"="+h}}}l.html+=">",s&&(l.html+=s),l=json2html._append(l,c),l.html+="</"+r+">"}return l},_guid:function(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+"-"+e()+e()+"-"+e()+e()},_getValue:function(e,t,i,n){var l="",a=t[i],o=typeof a;if("function"===o)return a.call(e,e,n);if("string"===o){var r=new json2html._tokenizer([/\$\{([^\}\{]+)\}/],function(t,i,n){return i?t.replace(n,function(t,i){for(var n=i.split("."),l=e,a="",o=n.length,r=0;o>r;++r)if(n[r].length>0){var s=l[n[r]];if(l=s,null===l||void 0===l)break}return null!==l&&void 0!==l&&(a=l),a}):t});l=r.parse(a).join("")}else l=a;return l},_tokenizer:function(e,t){return this instanceof json2html._tokenizer?(this.tokenizers=e.splice?e:[e],t&&(this.doBuild=t),this.parse=function(e){this.src=e,this.ended=!1,this.tokens=[];do this.next();while(!this.ended);return this.tokens},this.build=function(e,t){e&&this.tokens.push(this.doBuild?this.doBuild(e,t,this.tkn):e)},this.next=function(){var e,t=this;t.findMin(),e=t.src.slice(0,t.min),t.build(e,!1),t.src=t.src.slice(t.min).replace(t.tkn,function(e){return t.build(e,!0),""}),t.src||(t.ended=!0)},void(this.findMin=function(){var e,t,i=this,n=0;for(i.min=-1,i.tkn="";void 0!==(e=i.tokenizers[n++]);)t=i.src[e.test?"search":"indexOf"](e),-1!=t&&(-1==i.min||t<i.min)&&(i.tkn=e,i.min=t);-1==i.min&&(i.min=i.src.length)})):new json2html._tokenizer(e,t)}};!function(e){e.fn.json2html=function(t,i,n){if("undefined"==typeof json2html)return void 0;var l={append:!0,replace:!1,prepend:!1,eventData:{}};return void 0!==n&&e.extend(l,n),l.events=!0,this.each(function(){for(var n=json2html.transform(t,i,l),a=e(document.createElement("i")).html(n.html),o=0;o<n.events.length;o++){var r=n.events[o],s=e(a).find("[json2html-event-id-"+r.type+"='"+r.id+"']");if(0===s.length)throw"jquery.json2html was unable to attach event "+r.id+" to DOM";e(s).removeAttr("json2html-event-id-"+r.type),e(s).on(r.type,r.data,function(t){t.data.event=t,t.data.action.call(e(this),t.data)})}l.replace?e.fn.replaceWith.call(e(this),e(a).children()):l.prepend?e.fn.prepend.call(e(this),e(a).children()):e.fn.append.call(e(this),e(a).children())})}}(jQuery),TinyJSONGallery=[],TinyJSONGallery.version="2.0",TinyJSONGallery.base_url=TinyJSONGalleryBase,TinyJSONGallery.gallery_url=TinyJSONGalleryGallery,TinyJSONGallery.tinymce_skin_url=TinyJSONGalleryGallerySkin,TinyJSONGallery.gallery_url.indexOf(TinyJSONGallery.base_url)>=0&&TinyJSONGallery.base_url.length>1?TinyJSONGallery.gallery_rel_url=TinyJSONGallery.gallery_url.substr(TinyJSONGallery.gallery_url.lastIndexOf(TinyJSONGallery.base_url)+TinyJSONGallery.base_url.length):"/"==TinyJSONGallery.base_url&&(TinyJSONGallery.gallery_rel_url=TinyJSONGallery.gallery_url.substr(1)),tinyJSONGalleryDirLocation=TinyJSONGallery.gallery_rel_url+"images/nature/&autoCreateThumb=0&justJSON=1&options=w=178,h=117,zc=t";var scriptLoader=new tinymce.dom.ScriptLoader;tinymce.DOM.loadCSS(TinyJSONGallery.gallery_url+"colorbox/colorbox.css,"+TinyJSONGallery.gallery_url+"css/TinyJSONGallery.css,https://cdnjs.cloudflare.com/ajax/libs/jquery-tagsinput/1.3.6/jquery.tagsinput.min.css"),"undefined"==typeof json2html&&scriptLoader.add(TinyJSONGallery.gallery_url+"js/json2html.js"),scriptLoader.add("https://cdnjs.cloudflare.com/ajax/libs/jquery.colorbox/1.6.4/jquery.colorbox-min.js"),"undefined"==typeof jQuery.ui&&(tinymce.DOM.loadCSS("https://code.jquery.com/ui/1.8.24/themes/smoothness/jquery-ui.css"),scriptLoader.add("https://code.jquery.com/ui/1.11.4/jquery-ui.min.js")),scriptLoader.add("https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.min.js"),scriptLoader.add("https://cdnjs.cloudflare.com/ajax/libs/jquery-tagsinput/1.3.6/jquery.tagsinput.min.js"),$(document).on("dblclick","#mce-modal-block",function(){$(this).fadeOut();var e=Ext.getCmp("modx-leftbar-tabpanel"),t=e.find("id","modx-file-tree");e.setActiveTab(t[0])}),$(document).on("focus",".mce-gal-add-images input:visible",function(){$(".temp-gal-add-file").removeClass("temp-gal-add-file"),$(this).addClass("temp-gal-add-file")}),$(document).on("dblclick",".mce-gal-add-images input:visible",function(){autoFileBrowser(this.id,$(".mce-tinyJSONfolder").val(),"","","addGalFiles")});var galvalidExts=["png","gif","jpg"];$(document).on("mouseenter","[ext\\:tree-node-id]",function(){var e=$(this).attr("ext:tree-node-id"),t=e.substr(e.length-3),i=e.substring(e.lastIndexOf("/")+1);if($("#modx-file-tree:visible").length&&$(".mce-tinyJSONfolder:visible").length&&e.indexOf(".")>1&&$(this).hasClass("x-tree-node-leaf")&&e.indexOf("thumb/")<1){var n=$(this).attr("id"),l=e.substring(0,e.lastIndexOf("/")+1);$.inArray(t,galvalidExts)>-1&&($(".mce-gal-add-images:visible").length&&$(".temp-gal-add-file").val(i),$(".mce-tinyJSONfolder").attr("data-node-id",n).val(l))}}),jQuery.fn.fastLiveFilter=function(e,t,i){i=i||{},t=jQuery(t);var n,l=this,a=i.timeout||0,o=i.callback||function(){},r=t.children(),s=r.length,c=s>0?r[0].style.display:"inline-block";return o(s),l.change(function(){for(var t,i=l.val().toLowerCase(),n=0,a=0;s>a;a++)t=r[a],t.querySelector("a").getAttribute(e).toLowerCase().indexOf(i)>=0?("none"==t.style.display&&(t.style.display=c,$(t).find("a").addClass("cboxElement").removeClass("fHidden")),n++):"none"!=t.style.display&&(t.style.display="none",$(t).find("a").removeClass("cboxElement").addClass("fHidden"));return o(n),!1}).keydown(function(){clearTimeout(n),n=setTimeout(function(){l.change()},a)}),this},exitedGalleryToUseElementTree=0;var extraTW="";"undefined"!=typeof TinymceWrapper&&(extraTW="<h3>CUSTOMIZATION (TinymceWrapper Plugin)</h3><ol><li><strong>enableImageGallery</strong>: switch on/off this Gallery module in MODX</li><li><strong>tinyJSONGalleryTABtitle</strong>: change the text of the tab that appears next to Resource or Chunk tab</li><li><strong>tinyJSONGalleryTABposition</strong>: change position of this Gallery tab (# < 1 = first)</li><li><strong>galleryJSfile</strong>: backup your TinyJSONGallery.js file</li><li><strong>galleryChunkNameKey</strong>: specify what suffix a Chunk name is to have in order to transform said Chunk</li><li><strong>imageGalleryIDs</strong>: or... specify which Chunks will be Galleries by Chunk ids</li><li><strong>TinyJSONGalleryTV</strong>: Specify which TV is to be used to transform a Resource in to a Gallery</li></ol><h3>FRONTEND GALLERY MANAGER (using e.g, TinyMagicPublisher)</h3><ol><li><strong>&TinyJSONGallery.gallery_url =</strong>  `[[++assets_url]]`</li><li><strong>&TinyJSONGalleryJS =</strong> `[[++assets_url]]components/tinymcewrapper/gallery/js/TinyJSONGallery.js`</li><li><strong>&TinyJSONGallery.tinymce_skin_url =</strong> `[[++assets_url]]/components/tinymcewrapper/tinymceskins/modxPericles`</li><li>Once ready, you can programmatically initiate a Gallery with one line of code: <b>popGal(textareaForJSON, title, width, height, id)</b><br>All that this module needs is a textarea with JSON code in it</li></ol>"),tinyJSONgallHelp='<div id=tinyJSONLocationSettings></div><h3>Gallery Options</h3><ol><li>Options-&gt;<strong>Toggle Raw JSON Code Area</strong>, paste all valid code there, and <strong>Rebuild from Current JSON</strong> or <strong>from server</strong></li><li>Please Explore the rest of the options.</li></ol><h3>Getting started (prepare the code)</h3><ol><li>JSON first line is the location/settings:<br>[{"Location": "'+TinyJSONGallery.gallery_rel_url+"images/nature/&autoCreateThumb=0&justJSON=1&options=w=178,h=117,zc=t\"}]</li><li>Complete the JSON yourself, manually or</li><li>Generate it <strong>Options</strong>-&gt; Build/Visualize Gallery-&gt; Rebuild Thumbs/JSON (from Server)&nbsp;</li></ol><h3>JSON</h3><ol><li><strong>Location:<br></strong>the url from root to image folder + trailing slash&nbsp;...site.com/assets/images/ becomes <strong>assets/images/</strong><br>Use&nbsp;assets/images/ with&nbsp;<strong>autoCreateThumb=1</strong> (a folder named 'thumb' with thumbnails will be created for you )<br>Use&nbsp;assets/images/thumb/ with&nbsp;<strong><strong>autoCreateThumb=0</strong></strong> (i.e. if you are supplying your own thumbnails - use any name for the thumbs folder)</li><li><strong>&amp;autoCreateThumb: <br></strong><strong>1(yes)</strong> will create thumb folder and thumbs within the large images' folder (install <a href=https://modx.com/extras/package/resizer>MODX Resizer</a>)<br><strong>0(no)</strong> will assume you <strong>included</strong> a 'thumb' folder name in your <strong>location</strong>(<em>assets/images/thumb/</em> and that the folder is populated with your own thumbnails); it will work backwards to parent folder.</li><li><strong>&amp;justJSON:<br></strong><em>(works with&nbsp;autoCreateThumb=1)</em><strong><br>1(yes)&nbsp;</strong>use this to build/rebuild your gallery, this will not rebuild your thumbs, save your server resources!<br><strong>0(no)</strong> this will rebuild everything including thumbs (slower! best to do this once)</li><li><strong>&amp;options:<br></strong>Comma-separated list of what phpThumbs takes, courtesy of <a href=https://github.com/rthrash/Resizer target=_blank>MODX Resizer<br></a>Best to keep the dimensions 178x117 - or use CSS to fix Gallery ordered list.</li></ol>"+extraTW+'<h3>FRONTEND OUTPUT (Chunk or Resource TV)</h3><i>Note: the first item of the JSON is the location and settings (not a valid image item), use <b>offset</b> or whatever settings available to skip it - or just use &where to filter nicely</i><ol><li><strong>TinyJSONGalleryOutput</strong>:<br>[[!TinyJSONGalleryOutput?<br> &galleryChunkOrJson=`[[$NatureAlbum_myGallery]]` <b>OR ...(use a snippet to grap TV content of resource)</b><br>&tpl=`NatureAlbum_rowTpl` <br>&imgCls=`pic` <br>&rowCls=`magic` <br>&linkCls=`linked`]]</li><li><strong>MIGX getImageList</strong>:<br>[[!getImageList? <br>&offset=`1`<br>&where =`{"hidden:=":"0"}`<br>&sort=`[{"sortby":"index","sortdir":"DESC","sortmode":"numeric"},{"sortby":"title","sortdir":"ASC"}]`<br>&value=`[[$NatureAlbum_myGallery]]` <b>OR ...(&tvname=`TinyJSONGalleryTV`)</b><br>&tpl=`NatureAlbum_rowTpl`<br>&imgCls=`pic` &rowCls=`magic`<br>&linkCls=`linked`]]</li></ol><h3><strong>ENJOY, <br>donshakespeare</strong></h3>',"undefined"!=typeof extjsPanelTabs&&(tvChunkGalleriesNotice="modx-chunk-tabs"==extjsPanelTabs?"Main Gallery has safely and temporarily exited.<br><br>Visible Textareas of Chunks in the Elements Tree<br> can now be transformed into Visual Galleries.<br><br>Just double-click on each!":"Main Gallery has safely and temporarily exited.<br><br>Visible Textareas of TVs on this page and Chunks in the Elements Tree<br> can now be transformed into Visual Galleries.<br><br>Just double-click on each!"),"undefined"!=typeof backendOrfrontendGallery?Ext.onReady(function(){createTempEditorManager();var e=new MODx.Panel({title:tinyJSONGalleryTABtitle,id:"tinyJSONGallery",width:"100%",items:[{html:"<div id=tinyJSONGalleryWrapperEXtJS></div>"}]}),t=Ext.getCmp(extjsPanelTabs);t.insert(tinyJSONGalleryTABposition,e),t.setActiveTab(e),tradGal(0,textareaForJSON)}):createTempEditorManager();